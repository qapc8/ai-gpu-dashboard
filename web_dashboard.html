<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GPU Intel Pro — Market Terminal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
:root {
  --bg-0: #0f1720;
  --bg-1: #141e2b;
  --bg-2: #1a2535;
  --bg-3: #1f2d40;
  --bg-4: #253648;
  --bg-hover: #2a3d52;
  --border-0: #243044;
  --border-1: #2e3d55;
  --border-2: #3a4d66;
  --text-0: #f0f2f5;
  --text-1: #c8cdd6;
  --text-2: #8a95a6;
  --text-3: #5c6980;
  --blue: #4e8ff7;
  --blue-dim: rgba(78,143,247,0.12);
  --cyan: #22d3ee;
  --cyan-dim: rgba(34,211,238,0.10);
  --green: #3ecf8e;
  --green-dim: rgba(62,207,142,0.10);
  --red: #ef6461;
  --red-dim: rgba(239,100,97,0.10);
  --amber: #f0b429;
  --amber-dim: rgba(240,180,41,0.10);
  --purple: #a78bfa;
  --purple-dim: rgba(167,139,250,0.10);
  --orange: #fb923c;
  --orange-dim: rgba(251,146,60,0.10);
  --pink: #f472b6;
  --mono: 'JetBrains Mono', 'SF Mono', 'Fira Code', Consolas, monospace;
  --sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  --radius: 10px;
  --radius-sm: 5px;
  --shadow: 0 1px 3px rgba(0,0,0,0.3), 0 4px 12px rgba(0,0,0,0.15);
  --shadow-lg: 0 4px 20px rgba(0,0,0,0.4);
}

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-0);
  color: var(--text-1);
  font-family: var(--sans);
  font-size: 14px;
  line-height: 1.55;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ─── TOPBAR ─── */
.topbar {
  background: var(--bg-1);
  border-bottom: 1px solid var(--border-0);
  padding: 0 20px;
  height: 56px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
}
.topbar-brand {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.topbar-logo {
  width: 30px;
  height: 30px;
  border-radius: 7px;
  background: var(--blue);
  display: flex;
  align-items: center;
  justify-content: center;
  font-family: var(--sans);
  font-weight: 800;
  font-size: 14px;
  color: var(--bg-0);
}
.topbar-name {
  display: flex;
  flex-direction: column;
  line-height: 1.15;
}
.topbar-title {
  font-family: var(--sans);
  font-size: 13px;
  font-weight: 700;
  color: var(--text-0);
  letter-spacing: -0.2px;
  white-space: nowrap;
}
.topbar-subtitle {
  font-size: 10px;
  color: var(--text-3);
  font-weight: 500;
  font-family: var(--mono);
  letter-spacing: 0.5px;
  text-transform: uppercase;
}
.topbar-indicators {
  display: flex;
  align-items: center;
  gap: 0;
  overflow-x: auto;
  scrollbar-width: none;
  margin: 0 16px;
  flex: 1;
  justify-content: center;
}
.topbar-indicators::-webkit-scrollbar { display: none; }
.indicator {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 1px;
  font-family: var(--mono);
  padding: 5px 16px;
  white-space: nowrap;
  border-right: 1px solid var(--border-0);
  transition: background 0.15s;
  min-width: 0;
}
.indicator:hover { background: var(--bg-hover); }
.indicator:last-child { border-right: none; }
.indicator-label {
  color: var(--text-3);
  font-weight: 600;
  font-size: 9px;
  text-transform: uppercase;
  letter-spacing: 0.6px;
  line-height: 1;
}
.indicator-row {
  display: flex;
  align-items: center;
  gap: 6px;
}
.indicator-value { color: var(--text-0); font-weight: 700; font-size: 12px; line-height: 1; }
.indicator-change { font-weight: 600; font-size: 9.5px; padding: 1px 4px; border-radius: 3px; line-height: 1; }
.indicator-change.up { color: var(--green); background: rgba(34,197,94,0.12); }
.indicator-change.down { color: var(--red); background: rgba(239,68,68,0.12); }
.indicator-spark-svg { display: block; flex-shrink: 0; }
.indicator-sub { font-size: 9px; font-weight: 600; padding: 1px 4px; border-radius: 3px; letter-spacing: 0.3px; line-height: 1; }
.indicator-sub.up { color: var(--green); }
.indicator-sub.tag-green { color: var(--green); background: rgba(34,197,94,0.12); }
.indicator-sub.tag-amber { color: var(--amber); background: rgba(251,191,36,0.12); }
.indicator-sub.tag-red { color: var(--red); background: rgba(239,68,68,0.12); }
.indicator-divider { width: 1px; height: 32px; background: var(--border-1); margin: 0; flex-shrink: 0; }
.topbar-meta {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}
.live-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: var(--green);
  animation: blink 2s ease-in-out infinite;
  box-shadow: 0 0 6px var(--green);
}
@keyframes blink { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
.topbar-time {
  font-family: var(--mono);
  font-size: 10px;
  color: var(--text-3);
  line-height: 1.2;
  text-align: right;
}

/* ─── NEWS TICKER ─── */
.news-bar {
  background: var(--bg-1);
  border-bottom: 1px solid var(--border-0);
  height: 30px;
  overflow: hidden;
  position: relative;
  display: flex;
  align-items: center;
}
.news-label {
  position: absolute;
  left: 0; top: 0;
  height: 30px;
  padding: 0 12px;
  display: flex;
  align-items: center;
  background: var(--red);
  color: white;
  font-family: var(--mono);
  font-size: 9px;
  font-weight: 700;
  letter-spacing: 1px;
  z-index: 2;
}
.news-track {
  display: flex;
  align-items: center;
  height: 30px;
  white-space: nowrap;
  padding-left: 72px;
  animation: ticker 180s linear infinite;
}
.news-track:hover { animation-play-state: paused; }
.news-entry {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  margin-right: 48px;
  font-size: 11.5px;
}
.news-src { color: var(--cyan); font-weight: 600; font-family: var(--mono); font-size: 10px; }
.news-txt { color: var(--text-1); }
.news-tag {
  font-size: 8px;
  font-weight: 700;
  font-family: var(--mono);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  padding: 1px 5px;
  border-radius: 3px;
}
.news-tag-high { background: var(--red-dim); color: var(--red); }
.news-tag-medium { background: var(--amber-dim); color: var(--amber); }
.news-tag-low { background: var(--green-dim); color: var(--green); }
@keyframes ticker {
  0% { transform: translateX(0); }
  100% { transform: translateX(-50%); }
}

/* ─── NAV ─── */
.nav {
  background: var(--bg-2);
  border-bottom: 1px solid var(--border-0);
  display: flex;
  padding: 0 16px;
  gap: 1px;
  overflow-x: auto;
}
.nav-item {
  padding: 10px 18px;
  color: var(--text-3);
  cursor: pointer;
  font-size: 12.5px;
  font-weight: 600;
  letter-spacing: 0.3px;
  border-bottom: 2px solid transparent;
  transition: all 0.15s ease;
  white-space: nowrap;
  font-family: var(--sans);
  position: relative;
}
.nav-item:hover { color: var(--text-1); background: rgba(78,143,247,0.04); }
.nav-item.active {
  color: var(--text-0);
  border-bottom-color: var(--blue);
  background: rgba(78,143,247,0.06);
}
.nav-item.active::after {
  content: '';
  position: absolute;
  bottom: -1px;
  left: 0; right: 0;
  height: 2px;
  background: var(--blue);
}

/* ─── LAYOUT ─── */
.main { padding: 24px; }
.tab-panel { display: none; }
.tab-panel.active { display: block; }
.grid { display: grid; gap: 18px; }
.g-2 { grid-template-columns: 1fr 1fr; }
.g-3 { grid-template-columns: 1fr 1fr 1fr; }
.g-4 { grid-template-columns: 1fr 1fr 1fr 1fr; }
.g-7-3 { grid-template-columns: 7fr 3fr; }
.g-3-7 { grid-template-columns: 3fr 7fr; }
.g-6-4 { grid-template-columns: 6fr 4fr; }
.mb { margin-bottom: 18px; }

/* ─── CARDS ─── */
.card {
  background: var(--bg-2);
  border: 1px solid var(--border-0);
  border-radius: var(--radius);
  overflow: hidden;
  box-shadow: var(--shadow);
  transition: border-color 0.15s;
}
.card:hover { border-color: var(--border-1); }
.card-hd {
  padding: 14px 20px;
  border-bottom: 1px solid var(--border-0);
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: var(--bg-3);
}
.card-hd-title {
  font-family: var(--sans);
  font-size: 13px;
  font-weight: 700;
  letter-spacing: 0.3px;
  color: var(--text-1);
}
.card-hd-badge {
  font-size: 9px;
  font-weight: 600;
  padding: 2px 8px;
  border-radius: 3px;
  font-family: var(--mono);
  letter-spacing: 0.5px;
}
.card-bd { padding: 20px; }
.card-bd-flush { padding: 0; }

/* ─── KPI STRIP ─── */
.kpi-strip { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; }
.kpi {
  background: var(--bg-2);
  border: 1px solid var(--border-0);
  border-radius: var(--radius);
  padding: 20px 24px;
  position: relative;
  overflow: hidden;
  box-shadow: var(--shadow);
}
.kpi::before {
  content: '';
  position: absolute;
  top: 0; left: 0;
  width: 3px;
  height: 100%;
  border-radius: 3px 0 0 3px;
}
.kpi.kpi-blue::before { background: var(--blue); }
.kpi.kpi-green::before { background: var(--green); }
.kpi.kpi-red::before { background: var(--red); }
.kpi.kpi-amber::before { background: var(--amber); }
.kpi.kpi-purple::before { background: var(--purple); }
.kpi.kpi-cyan::before { background: var(--cyan); }
.kpi-label {
  font-size: 12px;
  letter-spacing: 0.3px;
  color: var(--text-3);
  font-weight: 600;
  margin-bottom: 6px;
}
.kpi-value {
  font-family: var(--sans);
  font-size: 28px;
  font-weight: 700;
  color: var(--text-0);
  line-height: 1.2;
}
.kpi-sub {
  font-size: 11px;
  color: var(--text-3);
  margin-top: 4px;
}
.kpi-sub .up { color: var(--green); font-weight: 600; }
.kpi-sub .dn { color: var(--red); font-weight: 600; }

/* ─── TABLES ─── */
.dt {
  width: 100%;
  border-collapse: collapse;
  font-family: var(--sans);
  font-size: 13px;
}
.dt thead th {
  padding: 10px 16px;
  text-align: left;
  background: var(--bg-3);
  color: var(--text-2);
  font-size: 11px;
  letter-spacing: 0.3px;
  font-weight: 700;
  border-bottom: 1px solid var(--border-1);
  position: sticky;
  top: 0;
  white-space: nowrap;
}
.dt thead th.r { text-align: right; }
.dt tbody td {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-0);
  white-space: nowrap;
}
.dt tbody td.r { text-align: right; font-variant-numeric: tabular-nums; }
.dt tbody tr:hover { background: var(--bg-hover); }
.dt tbody tr:nth-child(even) { background: rgba(255,255,255,0.02); }

.c-green { color: var(--green); font-weight: 600; }
.c-red { color: var(--red); font-weight: 600; }
.c-amber { color: var(--amber); }
.c-cyan { color: var(--cyan); }
.c-purple { color: var(--purple); }
.c-blue { color: var(--blue); }
.fw { font-weight: 700; }
.dim { color: var(--text-3); }
.gpu-name { color: var(--text-0); font-weight: 600; }

.tag {
  display: inline-block;
  padding: 2px 7px;
  border-radius: 3px;
  font-size: 9.5px;
  font-weight: 700;
  letter-spacing: 0.3px;
}
.tag-arch { background: var(--purple-dim); color: var(--purple); }
.tag-vendor-nvidia { background: var(--green-dim); color: var(--green); }
.tag-vendor-amd { background: var(--red-dim); color: var(--red); }
.tag-avail-scarce { background: var(--red-dim); color: var(--red); }
.tag-avail-limited { background: var(--orange-dim); color: var(--orange); }
.tag-avail-moderate { background: var(--amber-dim); color: var(--amber); }
.tag-avail-good { background: var(--green-dim); color: var(--green); }
.tag-avail-abundant { background: var(--cyan-dim); color: var(--cyan); }

/* ─── CHARTS ─── */
.chart-wrap { position: relative; width: 100%; }
.chart-wrap canvas { width: 100% !important; }

/* ─── FORMS ─── */
.ctrl-select {
  padding: 6px 10px;
  background: var(--bg-3);
  border: 1px solid var(--border-1);
  border-radius: var(--radius-sm);
  color: var(--text-0);
  font-family: var(--mono);
  font-size: 11.5px;
  outline: none;
  cursor: pointer;
  transition: border-color 0.15s;
}
.ctrl-select:focus { border-color: var(--blue); }
.ctrl-input {
  padding: 6px 10px;
  background: var(--bg-3);
  border: 1px solid var(--border-1);
  border-radius: var(--radius-sm);
  color: var(--text-0);
  font-family: var(--mono);
  font-size: 11.5px;
  outline: none;
  width: 100%;
}
.ctrl-input:focus { border-color: var(--blue); }
.btn {
  padding: 7px 16px;
  border: 1px solid var(--border-1);
  border-radius: var(--radius-sm);
  background: var(--bg-3);
  color: var(--text-1);
  cursor: pointer;
  font-size: 11px;
  font-family: var(--sans);
  font-weight: 600;
  transition: all 0.15s;
  letter-spacing: 0.3px;
}
.btn:hover { background: var(--bg-4); border-color: var(--border-2); color: var(--text-0); }
.btn-primary {
  background: var(--blue);
  border-color: var(--blue);
  color: white;
}
.btn-primary:hover { background: #3a7be0; }
.btn-accent {
  background: var(--orange);
  border-color: var(--orange);
  color: white;
}
.btn-accent:hover { background: #e07d2a; }

/* ─── AI PANELS ─── */
/* ─── AI PANELS ─── */
.ai-panel {
  background: var(--bg-2);
  border: 1px solid var(--border-1);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.ai-panel .card-hd { background: var(--bg-3); border-bottom-color: var(--border-1); }
.ai-panel .card-hd-title { color: var(--purple); }
.ai-body {
  padding: 20px;
  font-size: 13px;
  line-height: 1.8;
  max-height: 600px;
  overflow-y: auto;
  color: var(--text-1);
}
.ai-body h1, .ai-body h2, .ai-body h3 { color: var(--text-0); margin-top: 20px; margin-bottom: 10px; font-family: var(--sans); }
.ai-body h2 { font-size: 14px; border-bottom: 1px solid var(--border-0); padding-bottom: 6px; }
.ai-body h3 { font-size: 13px; color: var(--blue); }
.ai-body ul, .ai-body ol { padding-left: 20px; }
.ai-body li { margin-bottom: 6px; }
.ai-body strong { color: var(--amber); }
.ai-body code { background: var(--blue-dim); padding: 1px 5px; border-radius: 3px; color: var(--cyan); font-family: var(--mono); font-size: 12px; }
.ai-body p { margin-bottom: 10px; }
.ai-loading {
  display: flex; align-items: center; justify-content: center; flex-direction: column;
  padding: 48px; color: var(--text-3); gap: 12px; font-size: 12px;
}
.ai-loading .ai-spinner {
  width: 20px; height: 20px;
  border: 2px solid var(--purple);
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.ai-idle { display:flex; align-items:center; justify-content:center; padding:48px; color:var(--text-3); font-size:12px; flex-direction:column; gap:8px; }
.ai-idle-icon { font-size:24px; opacity:0.4; }

/* ─── AI SIGNAL TAGS ─── */
.ai-sig { display:inline-block; padding:2px 8px; border-radius:3px; font-size:9px; font-weight:800; letter-spacing:0.8px; font-family:var(--mono); margin-right:4px; vertical-align:middle; }
.ai-sig-buy { background:var(--green-dim); color:var(--green); }
.ai-sig-sell { background:var(--red-dim); color:var(--red); }
.ai-sig-hold { background:var(--amber-dim); color:var(--amber); }
.ai-sig-watch { background:var(--blue-dim); color:var(--blue); }
.ai-sig-alert { background:var(--red-dim); color:var(--red); }
.ai-sig-bull { background:var(--green-dim); color:var(--green); }
.ai-sig-bear { background:var(--red-dim); color:var(--red); }

/* ─── AI INTELLIGENCE HUB ─── */
.intel-grid { display:grid; grid-template-columns:1fr 1fr; gap:14px; }
.intel-card {
  background: var(--bg-2);
  border: 1px solid var(--border-0);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  transition: border-color 0.15s;
}
.intel-card:hover { border-color: var(--border-2); }
.intel-hd {
  padding: 10px 16px;
  border-bottom: 1px solid var(--border-0);
  display: flex; justify-content: space-between; align-items: center;
  background: var(--bg-3);
  border-radius: var(--radius) var(--radius) 0 0;
}
.intel-hd-left { display:flex; align-items:center; gap:10px; }
.intel-icon { width:28px; height:28px; border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:13px; flex-shrink:0; }
.intel-title { font-size:11.5px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; color:var(--text-1); font-family:var(--sans); }
.intel-sub { font-size:10px; color:var(--text-3); font-weight:500; }
.intel-status { font-size:9px; font-weight:600; font-family:var(--mono); padding:2px 8px; border-radius:10px; letter-spacing:0.5px; }
.intel-status-ready { background:var(--green-dim); color:var(--green); }
.intel-status-loading { background:var(--purple-dim); color:var(--purple); }
.intel-status-idle { background:rgba(92,105,128,0.15); color:var(--text-3); }
.intel-bd { padding:16px; max-height:480px; overflow-y:auto; }
.intel-bd .ai-body { padding:0; max-height:none; overflow:visible; }

/* ─── NOTES PANEL ─── */
.notes-panel {
  background: var(--bg-2);
  border: 1px solid var(--orange);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
}
.notes-panel .card-hd { background: var(--bg-3); border-bottom-color: var(--orange); }
.notes-panel .card-hd-title { color: var(--orange); }

/* ─── AI COMMAND BAR ─── */
.ai-cmdbar {
  display:flex; align-items:center; gap:10px; padding:12px 16px;
  background:var(--bg-2); border:1px solid var(--border-0);
  border-radius:var(--radius); margin-bottom:14px;
}
.ai-cmdbar-label { font-size:10px; text-transform:uppercase; letter-spacing:1px; color:var(--text-3); font-weight:700; font-family:var(--mono); white-space:nowrap; }
.ai-cmdbar-sep { width:1px; height:24px; background:var(--border-1); }
.ai-cmdbar .btn { font-size:10.5px; padding:5px 14px; }
.ai-chip {
  display:inline-flex; align-items:center; gap:4px;
  padding:3px 10px; border-radius:12px;
  font-size:10px; font-weight:600; font-family:var(--mono);
  cursor:pointer; transition:all 0.15s; border:1px solid transparent;
}
.ai-chip:hover { filter:brightness(1.2); }
.ai-chip-active { border-color:currentColor; }
.ai-chip-purple { background:var(--purple-dim); color:var(--purple); }
.ai-chip-blue { background:var(--blue-dim); color:var(--blue); }
.ai-chip-green { background:var(--green-dim); color:var(--green); }
.ai-chip-orange { background:var(--orange-dim); color:var(--orange); }
.ai-chip-cyan { background:var(--cyan-dim); color:var(--cyan); }
.ai-chip-red { background:var(--red-dim); color:var(--red); }
.ai-chip-amber { background:var(--amber-dim); color:var(--amber); }

/* ─── SPOT CARDS ─── */
.spot-tile {
  background: var(--bg-2);
  border: 1px solid var(--border-0);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}
.spot-tile-gpu { font-family: var(--mono); font-weight: 700; color: var(--text-0); font-size: 14px; margin-bottom: 10px; }
.spot-prices { display: flex; gap: 20px; margin-bottom: 8px; font-family: var(--mono); }
.spot-lbl { font-size: 9px; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.5px; }
.spot-bid-val { color: var(--green); font-weight: 700; font-size: 18px; }
.spot-ask-val { color: var(--red); font-weight: 700; font-size: 18px; }
.spot-meta-row { display: flex; gap: 14px; font-size: 10.5px; color: var(--text-3); font-family: var(--mono); }
.spot-mini { height: 44px; margin-top: 8px; }

/* ─── REGION CARDS ─── */
.region-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 14px; }
.region-tile {
  background: var(--bg-2);
  border: 1px solid var(--border-0);
  border-radius: var(--radius);
  padding: 14px;
  box-shadow: var(--shadow);
}
.region-tile-name { font-weight: 700; color: var(--text-0); margin-bottom: 8px; font-size: 12px; }
.region-row { display: flex; justify-content: space-between; font-size: 11px; padding: 2px 0; }
.region-row-k { color: var(--text-3); }
.region-row-v { color: var(--text-0); font-family: var(--mono); font-weight: 600; }

/* ─── SCROLLBAR ─── */
::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: var(--bg-1); }
::-webkit-scrollbar-thumb { background: var(--border-1); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--blue); }

/* ─── RESPONSIVE ─── */
@media (max-width: 1200px) {
  .g-2, .g-3, .g-4, .g-7-3, .g-3-7, .g-6-4 { grid-template-columns: 1fr; }
  .topbar-indicators { display: none; }
}
</style>
</head>
<body>

<!-- ═══ TOPBAR ═══ -->
<div class="topbar">
  <div class="topbar-brand">
    <div class="topbar-logo">G</div>
    <div class="topbar-name">
      <span class="topbar-title">GPU Intel Pro</span>
      <span class="topbar-subtitle">Market Terminal</span>
    </div>
  </div>
  <div class="topbar-indicators" id="tickerBar"></div>
  <div class="topbar-meta">
    <div class="live-dot"></div>
    <div class="topbar-time" id="headerTime"></div>
  </div>
</div>

<!-- ═══ NEWS TICKER ═══ -->
<div class="news-bar">
  <div class="news-label">LIVE</div>
  <div class="news-track" id="newsScroll"></div>
</div>

<!-- ═══ NAV ═══ -->
<div class="nav" id="navTabs">
  <div class="nav-item active" data-tab="overview">Overview</div>
  <div class="nav-item" data-tab="pricing">Price Matrix</div>
  <div class="nav-item" data-tab="trends">Trends</div>
  <div class="nav-item" data-tab="providers">Providers</div>
  <div class="nav-item" data-tab="regional">Regional</div>
  <div class="nav-item" data-tab="spot">Spot Market</div>
  <div class="nav-item" data-tab="inference">Inference</div>
  <div class="nav-item" data-tab="tco">TCO</div>
  <div class="nav-item" data-tab="workloads">Workloads</div>
  <div class="nav-item" data-tab="efficiency">Efficiency</div>
  <div class="nav-item" data-tab="forecasting">Forecasting</div>
  <div class="nav-item" data-tab="sustainability">Sustainability</div>
  <div class="nav-item" data-tab="model-fit">Model Fit</div>
  <div class="nav-item" data-tab="ai-analysis">AI Analysis</div>
</div>

<!-- ═══ MAIN ═══ -->
<div class="main">

<!-- ── OVERVIEW ── -->
<div class="tab-panel active" id="tab-overview">
  <div class="kpi-strip mb" id="overviewKpis"></div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Spot Market Snapshot</span><span class="card-hd-badge">LIVE</span></div>
      <div class="card-bd-flush"><table class="dt" id="overviewSpotTable"></table></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">GPU Price Trends — 12mo ($/hr avg)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:280px;"><canvas id="chartOverviewTrends"></canvas></div></div>
    </div>
  </div>
  <div class="grid g-3 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Market Size & AI CapEx ($B)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:250px;"><canvas id="chartMarketSize"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">GPU Shipments (K units/qtr)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:250px;"><canvas id="chartOverviewShipments"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">H100 Lead Time (weeks)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:250px;"><canvas id="chartOverviewLead"></canvas></div></div>
    </div>
  </div>
  <div class="grid g-6-4 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">GPU Market Matrix</span><span class="dim" style="font-size:10px;font-family:var(--mono);">On-demand $/hr — sorted by value</span></div>
      <div class="card-bd-flush"><table class="dt" id="overviewTopTable"></table></div>
    </div>
    <div class="ai-panel">
      <div class="card-hd">
        <span class="card-hd-title">AI Executive Summary</span>
        <button class="btn" onclick="loadAI('summary')">Refresh</button>
      </div>
      <div class="ai-body" id="aiSummaryContent"><div class="ai-loading">Generating analysis</div></div>
    </div>
  </div>
</div>

<!-- ── PRICING ── -->
<div class="tab-panel" id="tab-pricing">
  <div class="card mb">
    <div class="card-hd">
      <span class="card-hd-title">Complete GPU Price Matrix</span>
      <span class="dim" style="font-size:10px;font-family:var(--mono);">On-demand $/hr per GPU</span>
    </div>
    <div class="card-bd-flush" style="overflow-x:auto;"><table class="dt" id="priceMatrixTable"></table></div>
  </div>
  <div class="grid g-2">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Price Distribution by GPU</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartPriceDist"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Performance per Dollar (FP16 TFLOPS/$)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartFlopsPerDollar"></canvas></div></div>
    </div>
  </div>
</div>

<!-- ── TRENDS ── -->
<div class="tab-panel" id="tab-trends">
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd">
        <span class="card-hd-title">Historical Price Trends</span>
        <select class="ctrl-select" id="trendGpuSelect" onchange="updateTrendChart()"></select>
      </div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartTrends"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Availability Over Time</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartAvailability"></canvas></div></div>
    </div>
  </div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Data Center GPU Shipments (K units)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:260px;"><canvas id="chartShipments"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">H100 Lead Time (weeks)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:260px;"><canvas id="chartLeadTime"></canvas></div></div>
    </div>
  </div>
  <div class="card">
    <div class="card-hd"><span class="card-hd-title">All GPU Historical Comparison</span></div>
    <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartAllTrends"></canvas></div></div>
  </div>
</div>

<!-- ── PROVIDERS ── -->
<div class="tab-panel" id="tab-providers">
  <div style="margin-bottom:14px;display:flex;gap:10px;align-items:center;">
    <span class="dim" style="font-size:11px;">Select GPU:</span>
    <select class="ctrl-select" id="providerGpuSelect" onchange="updateProviderView()"></select>
  </div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title" id="providerChartTitle">Price Comparison</span><span class="card-hd-badge" style="background:var(--blue-dim);color:var(--blue);">Cloud</span><span class="card-hd-badge" style="background:var(--amber-dim);color:var(--amber);margin-left:4px;">Marketplace</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartProviders"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">On-Demand vs Reserved vs Spot</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartPriceTypes"></canvas></div></div>
    </div>
  </div>
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">Cloud Providers</span><span class="card-hd-badge" style="background:var(--blue-dim);color:var(--blue);">Own Infrastructure</span></div>
    <div class="card-bd-flush"><table class="dt" id="providerCloudTable"></table></div>
  </div>
  <div class="card">
    <div class="card-hd"><span class="card-hd-title">GPU Marketplaces</span><span class="card-hd-badge" style="background:var(--amber-dim);color:var(--amber);">Aggregated / Community Hardware</span></div>
    <div class="card-bd-flush"><table class="dt" id="providerMktTable"></table></div>
  </div>
</div>

<!-- ── REGIONAL ── -->
<div class="tab-panel" id="tab-regional">
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Market Share by Region</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartRegionShare"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">YoY Growth by Region</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartRegionGrowth"></canvas></div></div>
    </div>
  </div>
  <div class="region-grid mb" id="regionCards"></div>
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">Regional GPU Pricing Comparison ($/hr)</span></div>
    <div class="card-bd-flush"><table class="dt" id="regionalPricingTable"></table></div>
  </div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Regional Adoption Trend</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartRegionAdoption"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">AMD vs NVIDIA Market Share</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartAmdShare"></canvas></div></div>
    </div>
  </div>
  <div class="grid g-2">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Demand Index vs Price Premium</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:300px;"><canvas id="chartDemandVsPremium"></canvas></div></div>
    </div>
    <div class="card" style="border-color:var(--purple-dim);">
      <div class="card-hd" style="background:var(--bg-3);">
        <span class="card-hd-title" style="color:var(--purple);">AI Regional Analysis</span>
        <button class="btn" onclick="loadAI('regional');document.querySelector('[data-tab=ai-analysis]').click();" style="font-size:10px;">View in AI Hub</button>
      </div>
    </div>
  </div>
</div>

<!-- ── SPOT MARKET ── -->
<div class="tab-panel" id="tab-spot">
  <div class="kpi-strip mb" id="spotStats"></div>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px;margin-bottom:14px;" id="spotCards"></div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Spot Prices 24h ($/hr)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartSpot24h"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Bid-Ask Spread & Volatility</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartSpotSpread"></canvas></div></div>
    </div>
  </div>
  <div class="grid g-2">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">24h Trading Volume (GPU-hrs)</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:280px;"><canvas id="chartSpotVolume"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Available GPU Inventory</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:280px;"><canvas id="chartSpotInventory"></canvas></div></div>
    </div>
  </div>
</div>

<!-- ── INFERENCE ── -->
<div class="tab-panel" id="tab-inference">
  <div class="kpi-strip mb" id="inferenceStats"></div>
  <div class="card mb">
    <div class="card-hd">
      <span class="card-hd-title">Top 20 Models — $/M Tokens by Provider</span>
      <div style="display:flex;gap:8px;align-items:center;">
        <select id="inferCatFilter" style="background:var(--bg2);color:var(--fg);border:1px solid var(--border);border-radius:4px;padding:2px 8px;font-size:11px;font-family:var(--mono);">
          <option value="all">All Categories</option>
          <option value="Small">Small (&lt;10B)</option>
          <option value="Medium">Medium (10-30B)</option>
          <option value="Large">Large (30-200B)</option>
          <option value="Frontier">Frontier (200B+)</option>
        </select>
        <span class="dim" style="font-size:10px;font-family:var(--mono);">Provider API pricing</span>
      </div>
    </div>
    <div class="card-bd-flush" style="overflow-x:auto;"><table class="dt" id="inferenceTable"></table></div>
  </div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">$/M Tokens by Provider — Top Models</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:380px;"><canvas id="chartInferenceCost"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Self-Hosted GPU Cost vs Provider API</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:380px;"><canvas id="chartApiVsSelfHosted"></canvas></div></div>
    </div>
  </div>
  <div class="grid g-2">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Cost Frontier — Model Size vs $/M Tokens</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartInferenceThroughput"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Provider Coverage — Models per Provider</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartProviderCoverage"></canvas></div></div>
    </div>
  </div>
</div>

<!-- ── TCO ── -->
<div class="tab-panel" id="tab-tco">
  <div class="kpi-strip mb" id="tcoStats"></div>
  <div class="grid g-2 mb">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Cloud vs Self-Hosted TCO — $/hr</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:380px;"><canvas id="chartTcoStack"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title" id="tcoPieTitle">Break-Even Timeline — Self-Hosted vs Cloud</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:380px;"><canvas id="chartTcoPie"></canvas></div></div>
    </div>
  </div>
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">TCO Comparison by GPU</span></div>
    <div class="card-bd-flush" style="overflow-x:auto;"><table class="dt" id="tcoTable"></table></div>
  </div>
  <div class="card">
    <div class="card-hd"><span class="card-hd-title">Key Assumptions</span></div>
    <div class="card-bd" id="tcoAssumptions" style="font-size:.85rem;line-height:1.6;color:var(--c-sub);"></div>
  </div>
</div>

<!-- ── WORKLOADS ── -->
<div class="tab-panel" id="tab-workloads">
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">Workload-Based GPU Recommendations</span></div>
    <div class="card-bd-flush"><table class="dt" id="workloadTable"></table></div>
  </div>
  <div class="grid g-2">
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Monthly Cost by Workload</span></div>
      <div class="card-bd"><div class="chart-wrap" style="height:340px;"><canvas id="chartWorkloadCost"></canvas></div></div>
    </div>
    <div class="card">
      <div class="card-hd"><span class="card-hd-title">Cost Calculator</span></div>
      <div class="card-bd" id="costCalcBody">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
          <div>
            <label style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;">GPU Type</label>
            <select class="ctrl-select" id="calcGpu" style="width:100%;margin-top:4px;" onchange="calcCost()"></select>
          </div>
          <div>
            <label style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;">Provider</label>
            <select class="ctrl-select" id="calcProvider" style="width:100%;margin-top:4px;" onchange="calcCost()"></select>
          </div>
          <div>
            <label style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;"># GPUs</label>
            <input type="number" id="calcGpus" value="8" min="1" class="ctrl-input" style="margin-top:4px;" oninput="calcCost()">
          </div>
          <div>
            <label style="font-size:10px;color:var(--text-3);text-transform:uppercase;letter-spacing:0.5px;">Hours/Day</label>
            <input type="number" id="calcHours" value="24" min="1" max="24" class="ctrl-input" style="margin-top:4px;" oninput="calcCost()">
          </div>
        </div>
        <div id="calcResult" style="background:var(--bg-3);border-radius:var(--radius-sm);padding:16px;font-family:var(--mono);border:1px solid var(--border-0);"></div>
      </div>
    </div>
  </div>
</div>

<!-- ── EFFICIENCY ── -->
<div class="tab-panel" id="tab-efficiency">
  <div class="kpi-strip mb" id="effStats"></div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Utilization by Provider</span></div><div class="card-bd" style="height:320px;"><canvas id="chartUtilByProvider"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">Efficiency Scores</span></div><div class="card-bd" style="height:320px;"><canvas id="chartEfficiency"></canvas></div></div>
  </div>
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">Utilization Trends (5-month)</span></div><div class="card-bd" style="height:300px;"><canvas id="chartUtilTrend"></canvas></div>
  </div>
  <div class="card" style="border-color:var(--purple-dim);">
    <div class="card-hd" style="background:var(--bg-3);">
      <span class="card-hd-title" style="color:var(--purple);">AI Efficiency Analysis</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="btn" onclick="loadAI('efficiency');document.querySelector('[data-tab=ai-analysis]').click();" style="font-size:10px;">View in AI Hub</button>
      </div>
    </div>
  </div>
</div>

<!-- ── FORECASTING ── -->
<div class="tab-panel" id="tab-forecasting">
  <div class="kpi-strip mb" id="forecastStats"></div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Price Forecasts (3/6/12 Month)</span></div><div class="card-bd" style="height:360px;"><canvas id="chartForecast"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">Price Elasticity Coefficients</span></div><div class="card-bd" style="height:360px;"><canvas id="chartElasticity"></canvas></div></div>
  </div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Competitive Moat Radar</span></div><div class="card-bd" style="height:360px;"><canvas id="chartMoatRadar"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">Market Share Trends</span></div><div class="card-bd" style="height:360px;"><canvas id="chartMoatShare"></canvas></div></div>
  </div>
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">Competitive Landscape Detail</span></div>
    <div class="card-bd"><div id="competitiveTable"></div></div>
  </div>
  <div class="card" style="border-color:var(--purple-dim);">
    <div class="card-hd" style="background:var(--bg-3);">
      <span class="card-hd-title" style="color:var(--purple);">AI Price Forecast & Competitive Analysis</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="btn" onclick="loadAI('forecast');document.querySelector('[data-tab=ai-analysis]').click();" style="font-size:10px;">View in AI Hub</button>
      </div>
    </div>
  </div>
</div>

<!-- ── SUSTAINABILITY ── -->
<div class="tab-panel" id="tab-sustainability">
  <div class="kpi-strip mb" id="susStats"></div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Carbon Footprint by GPU (Annual, US avg)</span></div><div class="card-bd" style="height:320px;"><canvas id="chartCarbonByGpu"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">PUE & Green Energy by Provider</span></div><div class="card-bd" style="height:320px;"><canvas id="chartPueGreen"></canvas></div></div>
  </div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Supply Chain Risk Scores</span></div><div class="card-bd" style="height:300px;"><canvas id="chartSupplyRisk"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">Lead Time Trends (weeks)</span></div><div class="card-bd" style="height:300px;"><canvas id="chartRiskTrend"></canvas></div></div>
  </div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Sustainability Scores by Region</span></div><div class="card-bd"><div id="sustainabilityTable"></div></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">Export Control &amp; Regulatory Timeline</span></div><div class="card-bd" style="overflow-x:auto;"><div id="exportControlTable"></div></div></div>
  </div>
  <div class="card" style="border-color:var(--purple-dim);">
    <div class="card-hd" style="background:var(--bg-3);">
      <span class="card-hd-title" style="color:var(--purple);">AI Sustainability & Risk Analysis</span>
      <div style="display:flex;gap:6px;align-items:center;">
        <button class="btn" onclick="loadAI('sustainability');document.querySelector('[data-tab=ai-analysis]').click();" style="font-size:10px;">View in AI Hub</button>
      </div>
    </div>
  </div>
</div>

<!-- ── MODEL FIT ── -->
<div class="tab-panel" id="tab-model-fit">
  <div class="kpi-strip mb" id="fitStats"></div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Cost per 1M Tokens by Model Size & GPU</span></div><div class="card-bd" style="height:360px;"><canvas id="chartFitCost"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">Fit Score by Model Size & GPU</span></div><div class="card-bd" style="height:360px;"><canvas id="chartFitScore"></canvas></div></div>
  </div>
  <div class="grid g-2 mb">
    <div class="card"><div class="card-hd"><span class="card-hd-title">Throughput vs Cost Frontier</span></div><div class="card-bd" style="height:340px;"><canvas id="chartFitFrontier"></canvas></div></div>
    <div class="card"><div class="card-hd"><span class="card-hd-title">VRAM Headroom by Configuration</span></div><div class="card-bd" style="height:340px;"><canvas id="chartFitVram"></canvas></div></div>
  </div>
  <div class="card mb">
    <div class="card-hd"><span class="card-hd-title">Model-to-Hardware Fit Matrix</span></div>
    <div class="card-bd"><div id="fitTable"></div></div>
  </div>
</div>

<!-- ── AI ANALYSIS ── -->
<div class="tab-panel" id="tab-ai-analysis">

  <!-- Command Bar -->
  <div class="ai-cmdbar">
    <div class="ai-cmdbar-label">AI Intelligence</div>
    <div class="ai-cmdbar-sep"></div>
    <button class="btn btn-primary" onclick="loadAllAI()" id="btnGenerateAll">Generate All Reports</button>
    <button class="btn" onclick="refreshAllAI()">Refresh All (bypass cache)</button>
    <div class="ai-cmdbar-sep"></div>
    <select class="ctrl-select" id="aiGpuSelect" style="min-width:180px;"><option value="">-- GPU Deep Dive --</option></select>
    <button class="btn" onclick="loadGpuAI()">Analyze</button>
    <div style="margin-left:auto;display:flex;align-items:center;gap:8px;">
      <span class="ai-cmdbar-label" style="font-size:9px;">STATUS</span>
      <span class="intel-status intel-status-idle" id="aiGlobalStatus">IDLE</span>
    </div>
  </div>

  <!-- Analyst Notes — Top Priority (full width) -->
  <div class="notes-panel mb" id="notesSection">
    <div class="card-hd">
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="card-hd-title" style="color:var(--orange);">Analyst Market Notes</span>
        <span class="card-hd-badge" style="background:var(--orange-dim);color:var(--orange);">INSTITUTIONAL</span>
      </div>
      <div style="display:flex;gap:6px;">
        <button class="btn" onclick="loadAI('notes')">Generate</button>
      </div>
    </div>
    <div class="ai-body" id="aiNotesContent">
      <div class="ai-idle"><div class="ai-idle-icon">&#x1F4CB;</div><span>Click Generate or Generate All to create analyst notes with BUY/SELL/HOLD signals</span></div>
    </div>
  </div>

  <!-- Intelligence Cards Grid -->
  <div class="intel-grid mb">

    <!-- Market Trends -->
    <div class="intel-card" id="intelTrends">
      <div class="intel-hd">
        <div class="intel-hd-left">
          <div class="intel-icon" style="background:var(--blue-dim);color:var(--blue);">&#x1F4C8;</div>
          <div><div class="intel-title">Market Trends</div><div class="intel-sub">Pricing trajectories, supply/demand, generational shifts</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="intel-status intel-status-idle" id="statusTrends">IDLE</span>
          <button class="btn" onclick="loadAI('trends')" style="font-size:10px;padding:3px 10px;">Run</button>
        </div>
      </div>
      <div class="intel-bd"><div class="ai-body" id="aiTrendsContent">
        <div class="ai-idle"><div class="ai-idle-icon">&#x1F4C8;</div><span>Price trajectory, supply/demand dynamics, generational impact</span></div>
      </div></div>
    </div>

    <!-- Investment Outlook -->
    <div class="intel-card" id="intelInvestment">
      <div class="intel-hd">
        <div class="intel-hd-left">
          <div class="intel-icon" style="background:var(--green-dim);color:var(--green);">&#x1F4B0;</div>
          <div><div class="intel-title">Investment Outlook</div><div class="intel-sub">Buy vs rent, price floors, provider risk, budget planning</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="intel-status intel-status-idle" id="statusInvestment">IDLE</span>
          <button class="btn" onclick="loadAI('investment')" style="font-size:10px;padding:3px 10px;">Run</button>
        </div>
      </div>
      <div class="intel-bd"><div class="ai-body" id="aiInvestmentContent">
        <div class="ai-idle"><div class="ai-idle-icon">&#x1F4B0;</div><span>Buy/rent framework, price floors, transition timing, alpha opportunities</span></div>
      </div></div>
    </div>

    <!-- Regional Analysis -->
    <div class="intel-card" id="intelRegional">
      <div class="intel-hd">
        <div class="intel-hd-left">
          <div class="intel-icon" style="background:var(--cyan-dim);color:var(--cyan);">&#x1F30D;</div>
          <div><div class="intel-title">Regional Opportunities</div><div class="intel-sub">Price arbitrage, regulatory impact, deployment strategy</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="intel-status intel-status-idle" id="statusRegional">IDLE</span>
          <button class="btn" onclick="loadAI('regional')" style="font-size:10px;padding:3px 10px;">Run</button>
        </div>
      </div>
      <div class="intel-bd"><div class="ai-body" id="aiRegionalContent">
        <div class="ai-idle"><div class="ai-idle-icon">&#x1F30D;</div><span>Regional arbitrage, emerging markets, regulatory impact, energy costs</span></div>
      </div></div>
    </div>

    <!-- Efficiency Optimization -->
    <div class="intel-card" id="intelEfficiency">
      <div class="intel-hd">
        <div class="intel-hd-left">
          <div class="intel-icon" style="background:var(--amber-dim);color:var(--amber);">&#x26A1;</div>
          <div><div class="intel-title">Efficiency Optimization</div><div class="intel-sub">Utilization gaps, right-sizing, scheduling, cost savings</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="intel-status intel-status-idle" id="statusEfficiency">IDLE</span>
          <button class="btn" onclick="loadAI('efficiency')" style="font-size:10px;padding:3px 10px;">Run</button>
        </div>
      </div>
      <div class="intel-bd"><div class="ai-body" id="aiEfficiencyContent">
        <div class="ai-idle"><div class="ai-idle-icon">&#x26A1;</div><span>Utilization gaps, right-sizing, scheduling optimization, cost savings</span></div>
      </div></div>
    </div>

    <!-- Price Forecasts -->
    <div class="intel-card" id="intelForecast">
      <div class="intel-hd">
        <div class="intel-hd-left">
          <div class="intel-icon" style="background:var(--purple-dim);color:var(--purple);">&#x1F52E;</div>
          <div><div class="intel-title">Price Forecast & Competitive</div><div class="intel-sub">30/60/90-day outlook, elasticity, competitive displacement</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="intel-status intel-status-idle" id="statusForecast">IDLE</span>
          <button class="btn" onclick="loadAI('forecast')" style="font-size:10px;padding:3px 10px;">Run</button>
        </div>
      </div>
      <div class="intel-bd"><div class="ai-body" id="aiForecastContent">
        <div class="ai-idle"><div class="ai-idle-icon">&#x1F52E;</div><span>Price targets, elasticity analysis, competitive displacement, arbitrage</span></div>
      </div></div>
    </div>

    <!-- Sustainability & Risk -->
    <div class="intel-card" id="intelSustainability">
      <div class="intel-hd">
        <div class="intel-hd-left">
          <div class="intel-icon" style="background:var(--green-dim);color:var(--green);">&#x1F331;</div>
          <div><div class="intel-title">Sustainability & Supply Risk</div><div class="intel-sub">ESG ranking, carbon costs, supply chain, geopolitical risk</div></div>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span class="intel-status intel-status-idle" id="statusSustainability">IDLE</span>
          <button class="btn" onclick="loadAI('sustainability')" style="font-size:10px;padding:3px 10px;">Run</button>
        </div>
      </div>
      <div class="intel-bd"><div class="ai-body" id="aiSustainabilityContent">
        <div class="ai-idle"><div class="ai-idle-icon">&#x1F331;</div><span>ESG ranking, carbon costs, supply chain vulnerabilities, regulatory outlook</span></div>
      </div></div>
    </div>

  </div>

  <!-- GPU Deep Dive (full width) -->
  <div class="intel-card" id="intelGpuDive">
    <div class="intel-hd">
      <div class="intel-hd-left">
        <div class="intel-icon" style="background:var(--cyan-dim);color:var(--cyan);">&#x1F50D;</div>
        <div><div class="intel-title" id="aiGpuTitle">GPU Deep Dive</div><div class="intel-sub">Select a GPU above for detailed market positioning, pricing forecast, and provider recommendation</div></div>
      </div>
      <span class="intel-status intel-status-idle" id="statusGpu">IDLE</span>
    </div>
    <div class="intel-bd"><div class="ai-body" id="aiGpuContent">
      <div class="ai-idle"><div class="ai-idle-icon">&#x1F50D;</div><span>Select a GPU from the dropdown and click Analyze for a deep-dive report</span></div>
    </div></div>
  </div>

</div>

</div><!-- /main -->

<script>
// ════════════════════════════════════════════════════════════════
// DATA
// ════════════════════════════════════════════════════════════════
let DATA = {
  matrix:[], specs:{}, providers:{}, historical:{},
  indicators:{}, regional:{}, workloads:{},
  tco:{}, inference:{}, spot:{}, news:[],
  utilization:{}, reservations:{}, forecasts:{},
  competitive:{}, sustainability:{}, supplychain:{}, modelfit:{}
};

const C = {
  blue:'#4e8ff7', cyan:'#22d3ee', green:'#3ecf8e', red:'#ef6461',
  amber:'#f0b429', purple:'#a78bfa', orange:'#fb923c', pink:'#f472b6',
  teal:'#2dd4bf', indigo:'#818cf8', lime:'#a3e635', sky:'#38bdf8'
};
const CL = Object.values(C);
const PC = {
  'AWS':C.orange,'GCP':C.blue,'Azure':C.cyan,'Lambda':C.purple,
  'CoreWeave':C.green,'RunPod':C.pink,'Vast.ai':C.amber,
  'FluidStack':C.teal,'Oracle':C.red,'Together':C.indigo
};

Chart.defaults.color = '#5c6980';
Chart.defaults.borderColor = 'rgba(26,34,51,0.6)';
Chart.defaults.font.family = "'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif";
Chart.defaults.font.size = 11.5;
Chart.defaults.plugins.legend.labels.boxWidth = 12;
Chart.defaults.plugins.legend.labels.padding = 14;
Chart.defaults.elements.bar.borderRadius = 4;
Chart.defaults.elements.line.borderWidth = 2;
Chart.defaults.elements.point.radius = 3;

let charts = {};

// ════════════════════════════════════════════════════════════════
// LOADING
// ════════════════════════════════════════════════════════════════
const IS_STATIC = typeof EMBEDDED_DATA !== 'undefined';
async function fetchJSON(url) {
  const r = await fetch(url);
  const ct = r.headers.get('content-type') || '';
  if(!r.ok || !ct.includes('json')) throw new Error(`Server unavailable (${r.status})`);
  return r.json();
}

async function loadAllData() {
  const [matrix,specs,providers,historical,indicators,regional,workloads,tco,inference,spot,news,
         utilization,reservations,forecasts,competitive,sustainability,supplychain,modelfit] = await Promise.all([
    fetchJSON('/api/matrix'), fetchJSON('/api/specs'), fetchJSON('/api/providers'),
    fetchJSON('/api/historical'), fetchJSON('/api/indicators'), fetchJSON('/api/regional'),
    fetchJSON('/api/workloads'), fetchJSON('/api/tco'), fetchJSON('/api/inference'),
    fetchJSON('/api/spot'), fetchJSON('/api/news'),
    fetchJSON('/api/utilization'), fetchJSON('/api/reservations'), fetchJSON('/api/forecasts'),
    fetchJSON('/api/competitive'), fetchJSON('/api/sustainability'), fetchJSON('/api/supplychain'),
    fetchJSON('/api/modelfit'),
  ]);
  DATA = {matrix,specs,providers,historical,indicators,regional,workloads,tco,inference,spot,news,
          utilization,reservations,forecasts,competitive,sustainability,supplychain,modelfit};
  renderAll();
  loadAI('summary');
}

// ════════════════════════════════════════════════════════════════
// NAV
// ════════════════════════════════════════════════════════════════
document.querySelectorAll('.nav-item').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.nav-item').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
  });
});

// ════════════════════════════════════════════════════════════════
// RENDER ALL
// ════════════════════════════════════════════════════════════════
function renderAll() {
  renderTicker();
  renderNewsBanner();
  renderOverview();
  renderPriceMatrix();
  renderTrendsTab();
  renderProvidersTab();
  renderRegionalTab();
  renderWorkloadsTab();
  renderSpotTab();
  renderInferenceTab();
  renderTcoTab();
  renderEfficiencyTab();
  renderForecastingTab();
  renderSustainabilityTab();
  renderModelFitTab();
  populateSelectors();
  updateTime();
  setInterval(updateTime, 1000);
}

function updateTime() {
  document.getElementById('headerTime').textContent = new Date().toLocaleString('en-US', {
    year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit', second:'2-digit'
  });
}

// ════════════════════════════════════════════════════════════════
// TICKER
// ════════════════════════════════════════════════════════════════
function renderTicker() {
  const mi = DATA.indicators;
  const spot = DATA.spot;
  const tb = document.getElementById('tickerBar');
  if (!mi || !mi.nvidia_stock) return;

  // SVG sparkline from price array
  const spark = (prices, color, w=44, h=14) => {
    if (!prices || prices.length < 2) return '';
    const mn = Math.min(...prices), mx = Math.max(...prices), rng = mx - mn || 1;
    const pts = prices.map((p,i) => `${(i/(prices.length-1))*w},${h-((p-mn)/rng)*(h-2)-1}`).join(' ');
    return `<svg width="${w}" height="${h}" class="indicator-spark-svg"><polyline points="${pts}" fill="none" stroke="${color}" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round" opacity="0.85"/></svg>`;
  };

  // 24h % change from hourly prices
  const pctChg = (s) => {
    if (!s?.hourly_prices_24h?.length) return 0;
    const p = s.hourly_prices_24h;
    return ((p[p.length-1] - p[0]) / p[0] * 100).toFixed(1);
  };

  const chgBadge = (val, suffix='%') => {
    const cls = val >= 0 ? 'up' : 'down';
    return `<span class="indicator-change ${cls}">${val > 0 ? '+' : ''}${val}${suffix}</span>`;
  };

  // Stock: label on top, value + change on bottom row
  const mkStock = (label, price, ytdChg) => {
    return `<div class="indicator">
      <span class="indicator-label">${label}</span>
      <div class="indicator-row">
        <span class="indicator-value">$${price}</span>
        ${chgBadge(ytdChg)}
      </div>
    </div>`;
  };

  // Spot: label on top, sparkline + value + change on bottom row
  const mkSpot = (label, s, color) => {
    if (!s) return '';
    const chg = parseFloat(pctChg(s));
    return `<div class="indicator">
      <span class="indicator-label">${label}</span>
      <div class="indicator-row">
        ${spark(s.hourly_prices_24h, color)}
        <span class="indicator-value">$${s.last_trade.toFixed(2)}</span>
        ${chgBadge(chg)}
      </div>
    </div>`;
  };

  // Metric: label on top, value + sub-badge on bottom row
  const mkMetric = (label, value, sub, subCls) => {
    return `<div class="indicator">
      <span class="indicator-label">${label}</span>
      <div class="indicator-row">
        <span class="indicator-value">${value}</span>
        ${sub ? `<span class="indicator-sub ${subCls||''}">${sub}</span>` : ''}
      </div>
    </div>`;
  };

  // Derived data
  const leadKeys = Object.keys(mi.h100_lead_time_weeks).sort();
  const lead = mi.h100_lead_time_weeks[leadKeys[leadKeys.length-1]];
  const leadTag = lead <= 2 ? ['AVAILABLE','tag-green'] : lead <= 8 ? ['MODERATE','tag-amber'] : ['CONSTRAINED','tag-red'];

  const shipKeys = Object.keys(mi.data_center_gpu_shipments_k).sort();
  const latestShip = mi.data_center_gpu_shipments_k[shipKeys[shipKeys.length-1]];

  const amdKeys = Object.keys(mi.amd_gpu_market_share_pct).sort();
  const amdShare = mi.amd_gpu_market_share_pct[amdKeys[amdKeys.length-1]];

  const totalVol = spot ? Object.values(spot).reduce((s,g) => s + (g['24h_volume_gpu_hrs']||0), 0) : 0;

  const div = '<div class="indicator-divider"></div>';

  tb.innerHTML =
    mkStock('NVDA', mi.nvidia_stock.current, mi.nvidia_stock.ytd_change) +
    mkStock('AMD', mi.amd_stock.current, mi.amd_stock.ytd_change) +
    div +
    mkSpot('H100 SPOT', spot?.['H100-SXM'], '#22d3ee') +
    mkSpot('B200 SPOT', spot?.['B200'], '#a78bfa') +
    mkSpot('H200 SPOT', spot?.['H200'], '#4e8ff7') +
    div +
    mkMetric('AI CAPEX \'26', '$'+mi.ai_capex_bn['2026_est']+'B', '+40% YoY', 'up') +
    mkMetric('GPU MKT', '$'+mi.gpu_market_size_bn['2025']+'B', '+35%', 'up') +
    div +
    mkMetric('H100 LEAD', lead+'wk', leadTag[0], leadTag[1]) +
    mkMetric('AMD DC', amdShare+'%', 'mkt share', '') +
    mkMetric('SPOT VOL', (totalVol/1000).toFixed(0)+'K hrs', '', '');
}

// ════════════════════════════════════════════════════════════════
// NEWS
// ════════════════════════════════════════════════════════════════
function renderNewsBanner() {
  const news = DATA.news;
  if (!news || !news.length) return;
  const items = [...news, ...news];
  document.getElementById('newsScroll').innerHTML = items.map(n =>
    `<span class="news-entry">
      <span class="news-src">${n.source}</span>
      <span class="news-txt">${n.headline}</span>
      <span class="news-tag news-tag-${n.impact}">${n.impact}</span>
    </span>`
  ).join('');
}

// ════════════════════════════════════════════════════════════════
// OVERVIEW
// ════════════════════════════════════════════════════════════════
function renderOverview() {
  const m = DATA.matrix, mi = DATA.indicators, spot = DATA.spot;
  if (!m || !m.length) return;

  // KPI calculations
  const h100s = spot?.['H100-SXM'], b200s = spot?.['B200'], h200s = spot?.['H200'];
  const totalVol = spot ? Object.values(spot).reduce((s,g) => s + (g['24h_volume_gpu_hrs']||0), 0) : 0;
  const totalAvail = spot ? Object.values(spot).reduce((s,g) => s + (g.available_gpus||0), 0) : 0;
  const mktSize = mi.gpu_market_size_bn?.['2025'] || '--';
  const capex26 = mi.ai_capex_bn?.['2026_est'] || '--';
  const leadKeys = Object.keys(mi.h100_lead_time_weeks||{}).sort();
  const lead = mi.h100_lead_time_weeks?.[leadKeys[leadKeys.length-1]] || '--';
  const bestVal = m.reduce((a,b) => a.flops_per_dollar > b.flops_per_dollar ? a : b);
  const nProv = new Set(m.map(r => r.cheapest_provider)).size;

  const kpi = (cls, label, val, sub) => `<div class="kpi kpi-${cls}"><div class="kpi-label">${label}</div><div class="kpi-value">${val}</div><div class="kpi-sub">${sub}</div></div>`;

  document.getElementById('overviewKpis').innerHTML =
    kpi('cyan', 'H100 Spot', '$'+(h100s?.last_trade?.toFixed(2)||'--')+'/hr', `Bid $${h100s?.bid||'--'} / Ask $${h100s?.ask||'--'} &middot; <span class="up">${h100s?.available_gpus?.toLocaleString()||0} avail</span>`) +
    kpi('purple', 'B200 Spot', '$'+(b200s?.last_trade?.toFixed(2)||'--')+'/hr', `Spread ${b200s?.spread_pct||'--'}% &middot; Vol ${(b200s?.['24h_volume_gpu_hrs']||0).toLocaleString()} hrs`) +
    kpi('blue', 'Spot Volume (24h)', (totalVol/1000).toFixed(0)+'K GPU-hrs', `${totalAvail.toLocaleString()} GPUs available across ${nProv} providers`) +
    kpi('green', 'GPU Market 2025', '$'+mktSize+'B', `AI CapEx \'26E: <span class="up">$${capex26}B</span> (+40% YoY)`) +
    kpi('amber', 'H100 Lead Time', lead+' wk', lead <= 2 ? '<span class="up">Supply normalized</span>' : '<span class="dn">Constrained</span>') +
    kpi('red', 'Best Value GPU', bestVal.flops_per_dollar+' TFLOPS/$', `${bestVal.name} @ $${bestVal.cheapest_price.toFixed(2)}/hr`);

  renderOverviewSpotTable();
  renderOverviewTrendChart();
  renderMarketSizeChart();
  renderOverviewShipmentsChart();
  renderOverviewLeadChart();
  renderOverviewTable();
}

function renderOverviewSpotTable() {
  const spot = DATA.spot;
  if (!spot || !Object.keys(spot).length) return;
  const gpus = ['H100-SXM','B200','H200','A100-80GB','MI300X','RTX-4090'];
  let h = '<thead><tr><th>GPU</th><th class="r">Bid</th><th class="r">Ask</th><th class="r">Last</th><th class="r">Spread</th><th class="r">24h Low</th><th class="r">24h High</th><th class="r">24h Vol</th><th class="r">Avail</th><th>24h Trend</th></tr></thead><tbody>';
  gpus.forEach(g => {
    const s = spot[g]; if (!s) return;
    const prices = s.hourly_prices_24h||[];
    const chg = prices.length > 1 ? ((prices[prices.length-1]-prices[0])/prices[0]*100).toFixed(1) : 0;
    const chgCls = chg >= 0 ? 'c-green' : 'c-red';
    const chgSign = chg > 0 ? '+' : '';
    // Mini inline SVG sparkline
    let sparkSvg = '';
    if (prices.length > 1) {
      const mn=Math.min(...prices), mx=Math.max(...prices), rng=mx-mn||1;
      const clr = chg >= 0 ? '#34d399' : '#f87171';
      const pts = prices.map((p,i) => `${(i/(prices.length-1))*60},${18-((p-mn)/rng)*16-1}`).join(' ');
      sparkSvg = `<svg width="60" height="18" style="vertical-align:middle;"><polyline points="${pts}" fill="none" stroke="${clr}" stroke-width="1.3" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
    }
    h += `<tr><td class="gpu-name">${g}</td><td class="r">$${s.bid.toFixed(2)}</td><td class="r">$${s.ask.toFixed(2)}</td><td class="r fw">$${s.last_trade.toFixed(2)}</td><td class="r ${s.spread_pct > 15 ? 'c-red' : s.spread_pct > 10 ? 'c-amber' : 'c-green'}">${s.spread_pct}%</td><td class="r">$${s['24h_low'].toFixed(2)}</td><td class="r">$${s['24h_high'].toFixed(2)}</td><td class="r">${s['24h_volume_gpu_hrs'].toLocaleString()}</td><td class="r">${s.available_gpus.toLocaleString()}</td><td>${sparkSvg} <span class="${chgCls}" style="font-size:10px;">${chgSign}${chg}%</span></td></tr>`;
  });
  h += '</tbody>';
  document.getElementById('overviewSpotTable').innerHTML = h;
}

function renderOverviewTrendChart() {
  const hist = DATA.historical;
  const gpus = ['H100-SXM','B200','H200','A100-80GB','MI300X','RTX-4090'];
  const ap = new Set();
  gpus.forEach(g => { if(hist[g]) Object.keys(hist[g]).forEach(p => ap.add(p)); });
  const periods = [...ap].sort().slice(-12);
  const ds = gpus.map((g,i) => ({
    label:g, data:periods.map(p => hist[g]?.[p]?.avg||null),
    borderColor:CL[i], backgroundColor:CL[i]+'18', tension:0.35,
    pointRadius:2, borderWidth:2, fill:false, spanGaps:true,
  }));
  if(charts.ot) charts.ot.destroy();
  charts.ot = new Chart(document.getElementById('chartOverviewTrends'),{
    type:'line', data:{labels:periods, datasets:ds},
    options:{responsive:true, maintainAspectRatio:false,
      plugins:{legend:{position:'top'}},
      scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}
    }
  });
}

function renderMarketSizeChart() {
  const mi=DATA.indicators; if(!mi.gpu_market_size_bn) return;
  const mkt=mi.gpu_market_size_bn, capex=mi.ai_capex_bn;
  const yrs=['2023','2024','2025','2026','2027'];
  const yrLabels = yrs.map(y => (mkt[y+'_est']||capex[y+'_est']) ? y+'E' : y);
  if(charts.ms) charts.ms.destroy();
  charts.ms = new Chart(document.getElementById('chartMarketSize'),{
    type:'bar',
    data:{labels:yrLabels, datasets:[
      {label:'GPU Market ($B)',data:yrs.map(y=>mkt[y]||mkt[y+'_est']||null),backgroundColor:C.cyan+'70',borderColor:C.cyan,borderWidth:1},
      {label:'AI CapEx ($B)',data:yrs.map(y=>capex[y]||capex[y+'_est']||null),backgroundColor:C.purple+'70',borderColor:C.purple,borderWidth:1}
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},
      scales:{y:{title:{display:true,text:'$B'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });
}

function renderOverviewShipmentsChart() {
  const mi = DATA.indicators; if(!mi.data_center_gpu_shipments_k) return;
  const s = mi.data_center_gpu_shipments_k, lbl = Object.keys(s).sort();
  if(charts.ovShip) charts.ovShip.destroy();
  charts.ovShip = new Chart(document.getElementById('chartOverviewShipments'),{
    type:'bar',
    data:{labels:lbl, datasets:[{label:'DC GPU Shipments (K)',data:lbl.map(l=>s[l]),backgroundColor:C.cyan+'50',borderColor:C.cyan,borderWidth:1,borderRadius:3}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{y:{grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false},ticks:{maxRotation:45}}}}
  });
}

function renderOverviewLeadChart() {
  const mi = DATA.indicators; if(!mi.h100_lead_time_weeks) return;
  const lt = mi.h100_lead_time_weeks, lbl = Object.keys(lt).sort();
  if(charts.ovLead) charts.ovLead.destroy();
  charts.ovLead = new Chart(document.getElementById('chartOverviewLead'),{
    type:'line',
    data:{labels:lbl, datasets:[{label:'H100 Lead (wks)',data:lbl.map(l=>lt[l]),
      borderColor:C.amber,backgroundColor:C.amber+'20',fill:true,tension:0.3,pointRadius:2,borderWidth:2}]},
    options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}},
      scales:{y:{title:{display:true,text:'weeks'},grid:{color:'rgba(26,34,51,0.4)'},reverse:false},x:{grid:{display:false},ticks:{maxRotation:45}}}}
  });
}

function renderOverviewTable() {
  const m = DATA.matrix, spot = DATA.spot;
  let h = '<thead><tr><th>GPU</th><th>Vendor</th><th class="r">VRAM</th><th class="r">Best $/hr</th><th>Provider</th><th>Type</th><th class="r">Spot</th><th class="r">Spread</th><th class="r">MoM</th><th class="r">TFLOPS/$</th><th class="r">VRAM/$</th></tr></thead><tbody>';
  m.forEach(r => {
    const vc = r.vendor==='AMD' ? 'tag-vendor-amd' : 'tag-vendor-nvidia';
    const mc = r.monthly_change_pct<0 ? 'c-green' : 'c-red';
    const sp = spot?.[r.gpu_id];
    const spotPrice = sp ? '$'+sp.last_trade.toFixed(2) : '—';
    const spread = sp ? sp.spread_pct+'%' : '—';
    const spreadCls = sp ? (sp.spread_pct > 15 ? 'c-red' : sp.spread_pct > 10 ? 'c-amber' : 'c-green') : '';
    const isMkt = r.cheapest_provider_type === 'marketplace';
    const typeBadge = isMkt
      ? '<span class="tag" style="background:var(--amber-dim);color:var(--amber);font-size:9px;">MKT</span>'
      : '<span class="tag" style="background:var(--blue-dim);color:var(--blue);font-size:9px;">CLOUD</span>';
    h += `<tr><td class="gpu-name">${r.name}</td><td><span class="tag ${vc}">${r.vendor}</span></td><td class="r">${r.vram_gb}GB</td><td class="r c-green fw">$${r.cheapest_price.toFixed(2)}</td><td>${r.cheapest_provider}</td><td>${typeBadge}</td><td class="r">${spotPrice}</td><td class="r ${spreadCls}">${spread}</td><td class="r ${mc}">${r.monthly_change_pct>0?'+':''}${r.monthly_change_pct}%</td><td class="r c-purple">${r.flops_per_dollar}</td><td class="r c-cyan">${r.vram_per_dollar}</td></tr>`;
  });
  h += '</tbody>';
  document.getElementById('overviewTopTable').innerHTML = h;
}

// ════════════════════════════════════════════════════════════════
// PRICE MATRIX
// ════════════════════════════════════════════════════════════════
function renderPriceMatrix() {
  const m = DATA.matrix;
  let h = `<thead><tr><th>GPU</th><th>Vendor</th><th>Arch</th><th class="r">VRAM</th><th>Tier</th><th class="r">Best $/hr</th><th>Provider</th><th>Type</th><th class="r">Avg</th><th class="r">Max</th><th class="r">#Prov</th><th class="r">Spread</th><th class="r">MoM</th><th class="r">TFLOPS/$</th><th class="r">VRAM/$</th></tr></thead><tbody>`;
  m.forEach(r => {
    const vc = r.vendor==='AMD'?'tag-vendor-amd':'tag-vendor-nvidia';
    const mc = r.monthly_change_pct<0?'c-green':'c-red';
    const isMkt = r.cheapest_provider_type === 'marketplace';
    const typeBadge = isMkt
      ? '<span class="tag" style="background:var(--amber-dim);color:var(--amber);font-size:9px;">MKT</span>'
      : '<span class="tag" style="background:var(--blue-dim);color:var(--blue);font-size:9px;">CLOUD</span>';
    h += `<tr><td class="gpu-name">${r.name}</td><td><span class="tag ${vc}">${r.vendor}</span></td><td><span class="tag tag-arch">${r.arch}</span></td><td class="r">${r.vram_gb}GB</td><td>${r.tier}</td><td class="r c-green fw">$${r.cheapest_price.toFixed(2)}</td><td>${r.cheapest_provider}</td><td>${typeBadge}</td><td class="r">$${r.avg_price.toFixed(2)}</td><td class="r c-red">$${r.most_expensive.toFixed(2)}</td><td class="r">${r.num_providers}</td><td class="r">${r.price_spread_pct}%</td><td class="r ${mc}">${r.monthly_change_pct>0?'+':''}${r.monthly_change_pct}%</td><td class="r c-purple">${r.flops_per_dollar}</td><td class="r c-cyan">${r.vram_per_dollar}</td></tr>`;
  });
  h += '</tbody>';
  document.getElementById('priceMatrixTable').innerHTML = h;

  if(charts.pd) charts.pd.destroy();
  charts.pd = new Chart(document.getElementById('chartPriceDist'),{type:'bar',
    data:{labels:m.map(r=>r.gpu_id),datasets:[
      {label:'Best',data:m.map(r=>r.cheapest_price),backgroundColor:C.green+'80',borderColor:C.green,borderWidth:1},
      {label:'Avg',data:m.map(r=>r.avg_price),backgroundColor:C.amber+'80',borderColor:C.amber,borderWidth:1},
      {label:'Max',data:m.map(r=>r.most_expensive),backgroundColor:C.red+'50',borderColor:C.red,borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},
      scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  if(charts.fpd) charts.fpd.destroy();
  charts.fpd = new Chart(document.getElementById('chartFlopsPerDollar'),{type:'bar',
    data:{labels:m.map(r=>r.gpu_id),datasets:[{label:'FP16 TFLOPS/$',data:m.map(r=>r.flops_per_dollar),
      backgroundColor:m.map((_,i)=>CL[i%CL.length]+'70'),borderColor:m.map((_,i)=>CL[i%CL.length]),borderWidth:1}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},
      scales:{x:{title:{display:true,text:'TFLOPS/$'},grid:{color:'rgba(26,34,51,0.4)'}},y:{grid:{display:false}}}}
  });
}

// ════════════════════════════════════════════════════════════════
// TRENDS
// ════════════════════════════════════════════════════════════════
function renderTrendsTab() {
  const hist=DATA.historical, mi=DATA.indicators;

  if(mi.data_center_gpu_shipments_k){
    const s=mi.data_center_gpu_shipments_k, lbl=Object.keys(s).sort();
    if(charts.sh) charts.sh.destroy();
    charts.sh = new Chart(document.getElementById('chartShipments'),{type:'bar',
      data:{labels:lbl,datasets:[{label:'Shipments (K)',data:lbl.map(l=>s[l]),backgroundColor:C.cyan+'60',borderColor:C.cyan,borderWidth:1}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
    });
  }
  if(mi.h100_lead_time_weeks){
    const lt=mi.h100_lead_time_weeks, lbl=Object.keys(lt).sort();
    if(charts.lt) charts.lt.destroy();
    charts.lt = new Chart(document.getElementById('chartLeadTime'),{type:'line',
      data:{labels:lbl,datasets:[{label:'Lead Time (wk)',data:lbl.map(l=>lt[l]),borderColor:C.red,backgroundColor:C.red+'18',fill:true,tension:0.35,pointRadius:3}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{title:{display:true,text:'Weeks'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
    });
  }
  renderAllTrendsChart();
  updateTrendChart();
  renderAvailabilityChart();
}

function renderAllTrendsChart() {
  const hist=DATA.historical, gpus=Object.keys(hist);
  const ap=new Set(); gpus.forEach(g=>Object.keys(hist[g]).forEach(p=>ap.add(p)));
  const periods=[...ap].sort();
  const ds=gpus.map((g,i)=>({label:g,data:periods.map(p=>hist[g]?.[p]?.avg||null),borderColor:CL[i%CL.length],tension:0.35,pointRadius:1.5,borderWidth:2,fill:false,spanGaps:true}));
  if(charts.at) charts.at.destroy();
  charts.at = new Chart(document.getElementById('chartAllTrends'),{type:'line',data:{labels:periods,datasets:ds},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });
}

function updateTrendChart() {
  const sel=document.getElementById('trendGpuSelect');
  const gpuId=sel.value; const hist=DATA.historical[gpuId]; if(!hist) return;
  const p=Object.keys(hist).sort();
  if(charts.tr) charts.tr.destroy();
  charts.tr = new Chart(document.getElementById('chartTrends'),{type:'line',
    data:{labels:p,datasets:[
      {label:'Average',data:p.map(k=>hist[k].avg),borderColor:C.cyan,backgroundColor:C.cyan+'18',fill:true,tension:0.35,borderWidth:2},
      {label:'Min',data:p.map(k=>hist[k].min),borderColor:C.green,borderDash:[5,5],tension:0.35,borderWidth:1,pointRadius:0},
      {label:'Max',data:p.map(k=>hist[k].max),borderColor:C.red,borderDash:[5,5],tension:0.35,borderWidth:1,pointRadius:0},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:gpuId+' Price Band ($/hr)',color:C.cyan,font:{size:12}}},scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });
}

function renderAvailabilityChart() {
  const hist=DATA.historical;
  const am={'scarce':1,'limited':2,'moderate':3,'good':4,'abundant':5};
  const gpus=['H100-SXM','H200','A100-80GB','MI300X','RTX-4090'];
  const ap=new Set(); gpus.forEach(g=>{if(hist[g])Object.keys(hist[g]).forEach(p=>ap.add(p));});
  const periods=[...ap].sort().slice(-8);
  const ds=gpus.map((g,i)=>({label:g,data:periods.map(p=>hist[g]?.[p]?am[hist[g][p].availability]||0:null),borderColor:CL[i],tension:0.35,pointRadius:3,borderWidth:2,spanGaps:true}));
  if(charts.av) charts.av.destroy();
  charts.av = new Chart(document.getElementById('chartAvailability'),{type:'line',data:{labels:periods,datasets:ds},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{min:0,max:5.5,ticks:{callback:v=>['','Scarce','Limited','Moderate','Good','Abundant'][v]||''},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });
}

// ════════════════════════════════════════════════════════════════
// PROVIDERS
// ════════════════════════════════════════════════════════════════
function renderProvidersTab() { updateProviderView(); }

function updateProviderView() {
  const gpuId = document.getElementById('providerGpuSelect').value || 'H100-SXM';
  document.getElementById('providerChartTitle').textContent = `Price Comparison — ${gpuId}`;
  const pd = DATA.providers;
  const rows = [];
  for(const [prov,p] of Object.entries(pd)){
    if(p.gpus&&p.gpus[gpuId]){
      const g=p.gpus[gpuId]; const spot=g.price_per_gpu_hr*(1-p.spot_discount);
      const r1=g.price_per_gpu_hr*(1-p.reserved_1yr_discount); const r3=g.price_per_gpu_hr*(1-p.reserved_3yr_discount);
      rows.push({provider:prov,name:p.provider_name,type:p.type||'cloud',instance:g.instance,ondemand:g.price_per_gpu_hr,
        spot:p.spot_discount>0?spot:null,res1:r1,res3:r3,monthly:g.price_per_gpu_hr*730,regions:g.regions||{},spot_discount:p.spot_discount});
    }
  }
  rows.sort((a,b)=>a.ondemand-b.ondemand);

  const cloudRows = rows.filter(r => r.type === 'cloud');
  const mktRows = rows.filter(r => r.type === 'marketplace');

  // Bar chart: color-coded by type (blue=cloud, amber=marketplace)
  if(charts.pv) charts.pv.destroy();
  charts.pv = new Chart(document.getElementById('chartProviders'),{type:'bar',
    data:{labels:rows.map(r=>r.provider),datasets:[{label:'On-Demand $/hr',data:rows.map(r=>r.ondemand),
      backgroundColor:rows.map(r=> r.type==='marketplace' ? C.amber+'70' : (PC[r.provider]||C.blue)+'70'),
      borderColor:rows.map(r=> r.type==='marketplace' ? C.amber : (PC[r.provider]||C.blue)),borderWidth:1,
      borderDash: rows.map(r=> r.type==='marketplace' ? [3,3] : [])
    }]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},
      tooltip:{callbacks:{afterLabel:(ctx)=>rows[ctx.dataIndex]?.type==='marketplace'?'(Marketplace)':'(Cloud Provider)'}}},
      scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  // Grouped bar: on-demand/spot/reserved
  if(charts.pt) charts.pt.destroy();
  charts.pt = new Chart(document.getElementById('chartPriceTypes'),{type:'bar',
    data:{labels:rows.map(r=>r.provider),datasets:[
      {label:'On-Demand',data:rows.map(r=>r.ondemand),backgroundColor:C.amber+'70',borderColor:C.amber,borderWidth:1},
      {label:'Spot',data:rows.map(r=>r.spot||0),backgroundColor:C.green+'70',borderColor:C.green,borderWidth:1},
      {label:'1yr Reserved',data:rows.map(r=>r.res1),backgroundColor:C.blue+'70',borderColor:C.blue,borderWidth:1},
      {label:'3yr Reserved',data:rows.map(r=>r.res3),backgroundColor:C.purple+'70',borderColor:C.purple,borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  // Render cloud table
  const renderProvTable = (tableRows, elId) => {
    const best = tableRows[0]?.ondemand || 1;
    let h=`<thead><tr><th>Provider</th><th>Instance</th><th class="r">On-Demand</th><th class="r">Spot</th><th class="r">1yr Res.</th><th class="r">3yr Res.</th><th class="r">Monthly</th><th class="r">Annual</th><th class="r">vs Best</th><th>Regions</th></tr></thead><tbody>`;
    if(!tableRows.length) { h += '<tr><td colspan="10" class="dim" style="text-align:center;padding:20px;">No providers offer this GPU</td></tr>'; }
    tableRows.forEach(r=>{
      const prem=((r.ondemand-best)/best*100);
      const pc=prem===0?'c-green':'c-red';
      h+=`<tr><td style="color:${PC[r.provider]||C.blue};font-weight:700;">${r.provider}</td><td class="dim">${r.instance}</td><td class="r c-green fw">$${r.ondemand.toFixed(2)}</td><td class="r" style="color:var(--green)">${r.spot?'$'+r.spot.toFixed(2):'—'}</td><td class="r">$${r.res1.toFixed(2)}</td><td class="r c-cyan">$${r.res3.toFixed(2)}</td><td class="r">$${r.monthly.toFixed(0)}</td><td class="r">$${(r.monthly*12).toFixed(0)}</td><td class="r ${pc}">${prem===0?'BEST':'+'+prem.toFixed(1)+'%'}</td><td class="dim" style="font-size:10px;">${Object.keys(r.regions).join(', ')}</td></tr>`;
    });
    h+='</tbody>';
    document.getElementById(elId).innerHTML=h;
  };

  renderProvTable(cloudRows, 'providerCloudTable');
  renderProvTable(mktRows, 'providerMktTable');
}

// ════════════════════════════════════════════════════════════════
// REGIONAL
// ════════════════════════════════════════════════════════════════
function renderRegionalTab() {
  const reg=DATA.regional; if(!reg||!Object.keys(reg).length) return;
  const regions=Object.keys(reg), rd=Object.values(reg);

  if(charts.rs) charts.rs.destroy();
  charts.rs = new Chart(document.getElementById('chartRegionShare'),{type:'doughnut',
    data:{labels:regions,datasets:[{data:rd.map(r=>r.market_share_pct),backgroundColor:CL.slice(0,regions.length).map(c=>c+'80'),borderColor:CL.slice(0,regions.length),borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}
  });

  if(charts.rg) charts.rg.destroy();
  charts.rg = new Chart(document.getElementById('chartRegionGrowth'),{type:'bar',
    data:{labels:regions,datasets:[{label:'YoY Growth %',data:rd.map(r=>r.yoy_growth_pct),backgroundColor:rd.map((_,i)=>CL[i]+'70'),borderColor:rd.map((_,i)=>CL[i]),borderWidth:1}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'YoY Growth %'},grid:{color:'rgba(26,34,51,0.4)'}},y:{grid:{display:false}}}}
  });

  if(charts.dp) charts.dp.destroy();
  charts.dp = new Chart(document.getElementById('chartDemandVsPremium'),{type:'bubble',
    data:{datasets:regions.map((r,i)=>({label:r,data:[{x:reg[r].gpu_demand_index,y:reg[r].avg_price_premium_pct,r:Math.sqrt(reg[r].data_centers_count)*1.5}],backgroundColor:CL[i]+'50',borderColor:CL[i]}))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{x:{title:{display:true,text:'Demand Index'},grid:{color:'rgba(26,34,51,0.4)'}},y:{title:{display:true,text:'Price Premium %'},grid:{color:'rgba(26,34,51,0.4)'}}}}
  });

  let cHtml='';
  regions.forEach((r,i) => {
    const d=reg[r];
    cHtml += `<div class="region-tile" style="border-left:3px solid ${CL[i]}">
      <div class="region-tile-name">${r}</div>
      <div class="region-row"><span class="region-row-k">Market Share</span><span class="region-row-v">${d.market_share_pct}%</span></div>
      <div class="region-row"><span class="region-row-k">YoY Growth</span><span class="region-row-v" style="color:var(--green)">+${d.yoy_growth_pct}%</span></div>
      <div class="region-row"><span class="region-row-k">Demand Index</span><span class="region-row-v">${d.gpu_demand_index}/100</span></div>
      <div class="region-row"><span class="region-row-k">Price Premium</span><span class="region-row-v">+${d.avg_price_premium_pct}%</span></div>
      <div class="region-row"><span class="region-row-k">Energy Cost</span><span class="region-row-v">$${d.energy_cost_kwh}/kWh</span></div>
      <div class="region-row"><span class="region-row-k">Data Centers</span><span class="region-row-v">${d.data_centers_count.toLocaleString()}</span></div>
      <div class="region-row"><span class="region-row-k">Regulatory</span><span class="region-row-v">${d.regulatory_score}/10</span></div>
      <div style="margin-top:6px;font-size:10px;color:var(--text-3);">Top: ${d.top_providers.join(', ')}</div>
    </div>`;
  });
  document.getElementById('regionCards').innerHTML = cHtml;

  renderRegionalPricingTable(reg, regions);
  renderRegionAdoptionChart(reg, regions);
  renderAmdShareChart();
}

function renderRegionalPricingTable(reg, regions) {
  const gs=new Set(); regions.forEach(r=>{const gp=reg[r].gpu_pricing;if(gp)Object.keys(gp).forEach(g=>gs.add(g));});
  const gpus=[...gs];
  let h='<thead><tr><th>Region</th>';
  gpus.forEach(g=>{h+=`<th class="r" colspan="2">${g}</th>`;});
  h+='</tr><tr><th></th>';
  gpus.forEach(()=>{h+='<th class="r" style="font-size:9px;">Low</th><th class="r" style="font-size:9px;">High</th>';});
  h+='</tr></thead><tbody>';
  regions.forEach((r,i)=>{
    const gp=reg[r].gpu_pricing||{};
    h+=`<tr><td style="color:${CL[i]};font-weight:700;">${r}</td>`;
    gpus.forEach(g=>{
      if(gp[g]) h+=`<td class="r c-green">$${gp[g].low.toFixed(2)}</td><td class="r c-red">$${gp[g].high.toFixed(2)}</td>`;
      else h+='<td class="r dim">--</td><td class="r dim">--</td>';
    });
    h+='</tr>';
  });
  h+='</tbody>';
  document.getElementById('regionalPricingTable').innerHTML=h;
}

function renderRegionAdoptionChart(reg, regions) {
  const ap=new Set(); regions.forEach(r=>{const at=reg[r].adoption_trend_monthly;if(at)Object.keys(at).forEach(p=>ap.add(p));});
  const periods=[...ap].sort();
  const ds=regions.map((r,i)=>({label:r,data:periods.map(p=>reg[r].adoption_trend_monthly?.[p]||null),borderColor:CL[i],backgroundColor:CL[i]+'12',tension:0.35,pointRadius:1.5,borderWidth:2,fill:true,spanGaps:true}));
  if(charts.ra) charts.ra.destroy();
  charts.ra = new Chart(document.getElementById('chartRegionAdoption'),{type:'line',data:{labels:periods,datasets:ds},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{stacked:true,title:{display:true,text:'Share %'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });
}

function renderAmdShareChart() {
  const mi=DATA.indicators, as=mi.amd_gpu_market_share_pct; if(!as) return;
  const p=Object.keys(as).sort();
  if(charts.amd) charts.amd.destroy();
  charts.amd = new Chart(document.getElementById('chartAmdShare'),{type:'line',
    data:{labels:p,datasets:[
      {label:'AMD',data:p.map(k=>as[k]),borderColor:C.red,backgroundColor:C.red+'25',fill:true,tension:0.35,borderWidth:2},
      {label:'NVIDIA',data:p.map(k=>100-as[k]),borderColor:C.green,backgroundColor:C.green+'25',fill:true,tension:0.35,borderWidth:2},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{min:0,max:100,title:{display:true,text:'Market Share %'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });
}

// ════════════════════════════════════════════════════════════════
// WORKLOADS
// ════════════════════════════════════════════════════════════════
function renderWorkloadsTab() {
  const wl=DATA.workloads; if(!wl) return;
  let h=`<thead><tr><th>Workload</th><th>Recommended GPUs</th><th class="r">Min GPUs</th><th class="r">Budget/mo Low</th><th class="r">Budget/mo High</th><th>Best Value</th></tr></thead><tbody>`;
  const labels=[],lows=[],highs=[];
  for(const [name,rec] of Object.entries(wl)){
    labels.push(name); lows.push(rec.budget_monthly_low); highs.push(rec.budget_monthly_high);
    h+=`<tr><td class="gpu-name">${name}</td><td>${rec.recommended.join(', ')}</td><td class="r">${rec.min_gpus}</td><td class="r c-green">$${rec.budget_monthly_low.toLocaleString()}</td><td class="r c-red">$${rec.budget_monthly_high.toLocaleString()}</td><td class="c-cyan">${rec.best_value}</td></tr>`;
  }
  h+='</tbody>';
  document.getElementById('workloadTable').innerHTML=h;
  if(charts.wc) charts.wc.destroy();
  charts.wc = new Chart(document.getElementById('chartWorkloadCost'),{type:'bar',
    data:{labels,datasets:[
      {label:'Low Budget',data:lows,backgroundColor:C.green+'70',borderColor:C.green,borderWidth:1},
      {label:'High Budget',data:highs,backgroundColor:C.red+'50',borderColor:C.red,borderWidth:1},
    ]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},
      scales:{x:{type:'logarithmic',title:{display:true,text:'$/month (log)'},grid:{color:'rgba(26,34,51,0.4)'}},y:{grid:{display:false}}}}
  });
}

// ════════════════════════════════════════════════════════════════
// COST CALCULATOR
// ════════════════════════════════════════════════════════════════
function calcCost() {
  const gpuId=document.getElementById('calcGpu').value;
  const provId=document.getElementById('calcProvider').value;
  const numGpus=parseInt(document.getElementById('calcGpus').value)||1;
  const hrsDay=parseInt(document.getElementById('calcHours').value)||24;
  if(!gpuId||!DATA.providers[provId]?.gpus?.[gpuId]){
    document.getElementById('calcResult').innerHTML='<span class="dim">Select GPU and provider</span>'; return;
  }
  const pd=DATA.providers[provId], g=pd.gpus[gpuId], hr=g.price_per_gpu_hr;
  const daily=hr*hrsDay*numGpus, monthly=daily*30, yearly=daily*365;
  const spot=hr*(1-pd.spot_discount), r1=hr*(1-pd.reserved_1yr_discount), r3=hr*(1-pd.reserved_3yr_discount);
  document.getElementById('calcResult').innerHTML=`
    <div style="margin-bottom:10px;color:var(--cyan);font-weight:700;">${DATA.specs[gpuId]?.name||gpuId} x${numGpus} @ ${provId}</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
      <div>On-Demand/hr: <span class="c-green fw">$${(hr*numGpus).toFixed(2)}</span></div>
      <div>Daily: <span class="c-green fw">$${daily.toFixed(0)}</span></div>
      <div>Monthly: <span style="color:var(--amber);font-weight:700;">$${monthly.toLocaleString('en',{maximumFractionDigits:0})}</span></div>
      <div>Yearly: <span style="color:var(--orange);font-weight:700;">$${yearly.toLocaleString('en',{maximumFractionDigits:0})}</span></div>
    </div>
    <hr style="border-color:var(--border-0);margin:10px 0;">
    <div style="font-size:11px;">
      <div>Spot: $${(spot*numGpus*hrsDay*30).toFixed(0)}/mo ${pd.spot_discount>0?'(save '+(pd.spot_discount*100)+'%)':'(N/A)'}</div>
      <div>1yr Reserved: $${(r1*numGpus*hrsDay*30).toFixed(0)}/mo (save ${(pd.reserved_1yr_discount*100)}%)</div>
      <div>3yr Reserved: $${(r3*numGpus*hrsDay*30).toFixed(0)}/mo (save ${(pd.reserved_3yr_discount*100)}%)</div>
    </div>`;
}

// ════════════════════════════════════════════════════════════════
// SELECTORS
// ════════════════════════════════════════════════════════════════
function populateSelectors() {
  const gpus=Object.keys(DATA.specs), provs=Object.keys(DATA.providers);
  [document.getElementById('trendGpuSelect'),document.getElementById('providerGpuSelect'),
   document.getElementById('calcGpu'),document.getElementById('aiGpuSelect')].forEach(sel=>{
    if(!sel) return;
    const ex=sel.value, hb=sel.id==='aiGpuSelect';
    sel.innerHTML=(hb?'<option value="">-- Select GPU --</option>':'')+
      gpus.filter(g=>DATA.historical[g]||sel.id!=='trendGpuSelect')
        .map(g=>`<option value="${g}" ${g===ex?'selected':''}>${DATA.specs[g]?.name||g}</option>`).join('');
    if(!ex&&!hb&&sel.options.length) sel.value=sel.options[0].value;
  });
  const ps=document.getElementById('calcProvider');
  ps.innerHTML=provs.map(p=>`<option value="${p}">${p}</option>`).join('');
}

// ════════════════════════════════════════════════════════════════
// SPOT MARKET
// ════════════════════════════════════════════════════════════════
function renderSpotTab() {
  const spot=DATA.spot; if(!spot||!Object.keys(spot).length) return;
  const gpus=Object.keys(spot), sd=Object.values(spot);
  const totalVol=sd.reduce((s,d)=>s+d['24h_volume_gpu_hrs'],0);
  const avgSpread=(sd.reduce((s,d)=>s+d.spread_pct,0)/sd.length).toFixed(1);
  const totalInv=sd.reduce((s,d)=>s+d.available_gpus,0);
  const topVol=gpus.reduce((a,b)=>spot[a]['24h_volume_gpu_hrs']>spot[b]['24h_volume_gpu_hrs']?a:b);

  document.getElementById('spotStats').innerHTML=`
    <div class="kpi kpi-cyan"><div class="kpi-label">24h Total Volume</div><div class="kpi-value">${totalVol.toLocaleString()}</div><div class="kpi-sub">GPU-hours traded</div></div>
    <div class="kpi kpi-green"><div class="kpi-label">Avg Bid-Ask Spread</div><div class="kpi-value">${avgSpread}%</div><div class="kpi-sub">Across ${gpus.length} GPUs</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">Available Inventory</div><div class="kpi-value">${totalInv.toLocaleString()}</div><div class="kpi-sub">GPUs on market</div></div>
    <div class="kpi kpi-purple"><div class="kpi-label">Most Active</div><div class="kpi-value">${topVol}</div><div class="kpi-sub">${spot[topVol]['24h_volume_gpu_hrs'].toLocaleString()} GPU-hrs</div></div>`;

  let cHtml='';
  gpus.forEach((g,i)=>{
    const d=spot[g];
    cHtml+=`<div class="spot-tile" style="border-top:2px solid ${CL[i%CL.length]}">
      <div class="spot-tile-gpu">${g}<span style="float:right;font-size:11px;color:var(--amber);">Spread: ${d.spread_pct}%</span></div>
      <div class="spot-prices"><div><div class="spot-lbl">Bid</div><div class="spot-bid-val">$${d.bid.toFixed(2)}</div></div><div><div class="spot-lbl">Ask</div><div class="spot-ask-val">$${d.ask.toFixed(2)}</div></div></div>
      <div class="spot-meta-row"><span>Vol: ${d['24h_volume_gpu_hrs'].toLocaleString()}</span><span>Avail: ${d.available_gpus.toLocaleString()}</span><span>30d Vol: ${d.volatility_30d}%</span></div>
      <div class="spot-mini"><canvas id="sm_${g.replace(/[^a-zA-Z0-9]/g,'_')}" height="44"></canvas></div>
    </div>`;
  });
  document.getElementById('spotCards').innerHTML=cHtml;

  gpus.forEach((g,i)=>{
    const cv=document.getElementById(`sm_${g.replace(/[^a-zA-Z0-9]/g,'_')}`);
    if(!cv) return;
    const prices=spot[g].hourly_prices_24h||[];
    new Chart(cv,{type:'line',data:{labels:prices.map((_,j)=>j+'h'),datasets:[{data:prices,borderColor:CL[i%CL.length],backgroundColor:CL[i%CL.length]+'15',fill:true,tension:0.35,pointRadius:0,borderWidth:1.5}]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}});
  });

  const topG=gpus.slice(0,6), hrs=Array.from({length:24},(_,i)=>i+'h');
  if(charts.s24) charts.s24.destroy();
  charts.s24=new Chart(document.getElementById('chartSpot24h'),{type:'line',
    data:{labels:hrs,datasets:topG.map((g,i)=>({label:g,data:spot[g].hourly_prices_24h||[],borderColor:CL[i],tension:0.35,pointRadius:2,borderWidth:2,fill:false}))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  if(charts.ss) charts.ss.destroy();
  charts.ss=new Chart(document.getElementById('chartSpotSpread'),{type:'bar',
    data:{labels:gpus,datasets:[
      {label:'Spread %',data:sd.map(d=>d.spread_pct),backgroundColor:C.amber+'70',borderColor:C.amber,borderWidth:1},
      {label:'30d Volatility %',data:sd.map(d=>d.volatility_30d),backgroundColor:C.red+'50',borderColor:C.red,borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'%'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  if(charts.sv) charts.sv.destroy();
  charts.sv=new Chart(document.getElementById('chartSpotVolume'),{type:'bar',
    data:{labels:gpus,datasets:[{label:'24h Volume',data:sd.map(d=>d['24h_volume_gpu_hrs']),backgroundColor:gpus.map((_,i)=>CL[i%CL.length]+'70'),borderColor:gpus.map((_,i)=>CL[i%CL.length]),borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{title:{display:true,text:'GPU-hrs'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  if(charts.si) charts.si.destroy();
  charts.si=new Chart(document.getElementById('chartSpotInventory'),{type:'bar',
    data:{labels:gpus,datasets:[{label:'Available GPUs',data:sd.map(d=>d.available_gpus),backgroundColor:gpus.map((_,i)=>CL[i%CL.length]+'50'),borderColor:gpus.map((_,i)=>CL[i%CL.length]),borderWidth:1}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{title:{display:true,text:'GPUs'},grid:{color:'rgba(26,34,51,0.4)'}},y:{grid:{display:false}}}}
  });
}

// ════════════════════════════════════════════════════════════════
// INFERENCE
// ════════════════════════════════════════════════════════════════
function renderInferenceTab(filterCat) {
  const inf=DATA.inference; if(!inf||!Object.keys(inf).length) return;
  const allModels=Object.keys(inf);
  const cat=filterCat||'all';
  const models=cat==='all'?allModels:allModels.filter(m=>inf[m].category===cat);

  // Collect all providers across models
  const provSet=new Set();
  models.forEach(m=>{if(inf[m].providers)Object.keys(inf[m].providers).forEach(p=>provSet.add(p));});
  const providers=[...provSet].sort();

  // Collect all provider prices for stats
  const allPrices=[]; const selfHostedPrices=[];
  models.forEach(m=>{
    if(inf[m].providers) Object.values(inf[m].providers).forEach(p=>{if(p>0)allPrices.push(p);});
    if(inf[m].gpus) Object.values(inf[m].gpus).forEach(g=>{if(g.cost_per_1m_tokens>0)selfHostedPrices.push(g.cost_per_1m_tokens);});
  });
  const cheapestProv=allPrices.length?Math.min(...allPrices):0;
  const avgProv=allPrices.length?(allPrices.reduce((a,b)=>a+b,0)/allPrices.length):0;
  const cheapestSelf=selfHostedPrices.length?Math.min(...selfHostedPrices):0;

  // Find #1 ranked model price for reference
  const topModel=allModels.find(m=>inf[m].rank===1)||allModels[0];
  const topPrice=inf[topModel]?.providers?Math.min(...Object.values(inf[topModel].providers).filter(v=>v>0)):0;

  document.getElementById('inferenceStats').innerHTML=`
    <div class="kpi kpi-green"><div class="kpi-label">Cheapest Provider</div><div class="kpi-value">$${cheapestProv.toFixed(3)}</div><div class="kpi-sub">Per M tokens (API)</div></div>
    <div class="kpi kpi-cyan"><div class="kpi-label">Avg Provider Price</div><div class="kpi-value">$${avgProv.toFixed(2)}</div><div class="kpi-sub">Across ${providers.length} providers</div></div>
    <div class="kpi kpi-purple"><div class="kpi-label">Models Tracked</div><div class="kpi-value">${allModels.length}</div><div class="kpi-sub">${models.length} shown · OpenRouter Top 20</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">#1 ${topModel}</div><div class="kpi-value">$${topPrice.toFixed(2)}</div><div class="kpi-sub">Most popular model</div></div>`;

  // Build table: Model | Params | Cat | Provider1 | Provider2 | ... | Best Provider | Best Self-Hosted
  const catColors={Small:'#22c55e',Medium:'#3b82f6',Large:'#a855f7',Frontier:'#f59e0b'};
  let h='<thead><tr><th style="position:sticky;left:0;background:var(--card);z-index:2;width:30px;">#</th><th style="background:var(--card);">Model</th><th class="r">Params</th><th>Cat</th>';
  providers.forEach(p=>{h+=`<th class="r" style="font-size:10px;white-space:nowrap;">${p}</th>`;});
  h+='<th class="r" style="background:rgba(34,197,94,0.08);">Best API</th><th class="r" style="background:rgba(56,189,248,0.08);">Best GPU</th>';
  h+='</tr></thead><tbody>';

  // Sort models by rank (usage popularity)
  const sorted=[...models].sort((a,b)=>(inf[a].rank||99)-(inf[b].rank||99));

  sorted.forEach(m=>{
    const d=inf[m];
    const provPrices=d.providers||{};
    const provVals=Object.values(provPrices).filter(v=>v>0);
    const bestProv=provVals.length?Math.min(...provVals):null;
    const gpuVals=d.gpus?Object.values(d.gpus).map(g=>g.cost_per_1m_tokens).filter(v=>v>0):[];
    const bestGpu=gpuVals.length?Math.min(...gpuVals):null;
    const cc=catColors[d.category]||'#666';
    h+=`<tr><td style="position:sticky;left:0;background:var(--card);z-index:1;font-family:var(--mono);font-size:11px;color:var(--fg2);text-align:center;">${d.rank||''}</td>`;
    h+=`<td class="gpu-name" style="white-space:nowrap;">${m}</td>`;
    h+=`<td class="r" style="font-family:var(--mono);font-size:11px;">${d.params_b}B</td>`;
    h+=`<td><span style="background:${cc}20;color:${cc};padding:1px 6px;border-radius:3px;font-size:10px;font-weight:600;">${d.category}</span></td>`;
    providers.forEach(p=>{
      const price=provPrices[p];
      if(price!=null && price>0){
        const isBest=price===bestProv;
        h+=`<td class="r" style="font-family:var(--mono);font-size:11px;${isBest?'color:var(--green);font-weight:700;':''}">$${price<1?price.toFixed(3):price.toFixed(2)}</td>`;
      } else {
        h+='<td class="r dim" style="font-size:10px;">—</td>';
      }
    });
    h+=`<td class="r" style="background:rgba(34,197,94,0.08);font-family:var(--mono);font-size:11px;font-weight:700;color:var(--green);">${bestProv!=null?'$'+(bestProv<1?bestProv.toFixed(3):bestProv.toFixed(2)):'—'}</td>`;
    h+=`<td class="r" style="background:rgba(56,189,248,0.08);font-family:var(--mono);font-size:11px;color:var(--cyan);">${bestGpu!=null?'$'+(bestGpu<1?bestGpu.toFixed(3):bestGpu.toFixed(2)):'—'}</td>`;
    h+='</tr>';
  });
  h+='</tbody>';
  document.getElementById('inferenceTable').innerHTML=h;

  // Chart 1: $/M Tokens by Provider for key models (grouped bar)
  const chartModels=sorted.filter(m=>inf[m].type==='LLM'&&inf[m].providers&&Object.keys(inf[m].providers).length>=3).slice(0,10);
  const topProviders=['Together','Fireworks','Groq','DeepInfra','AWS Bedrock','Azure'].filter(p=>provSet.has(p));
  if(charts.ic) charts.ic.destroy();
  charts.ic=new Chart(document.getElementById('chartInferenceCost'),{type:'bar',
    data:{labels:chartModels,datasets:topProviders.map((p,i)=>({
      label:p,
      data:chartModels.map(m=>inf[m].providers?.[p]||null),
      backgroundColor:CL[i%CL.length]+'70',borderColor:CL[i%CL.length],borderWidth:1
    }))},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{boxWidth:10,font:{size:10}}}},
      scales:{y:{title:{display:true,text:'$/M Tokens'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false},ticks:{font:{size:9},maxRotation:45}}}}
  });

  // Chart 2: Self-hosted GPU cost vs Provider API for 70B-class models
  const compModels=sorted.filter(m=>{const p=inf[m].params_b;return inf[m].type==='LLM'&&p>=7&&Object.keys(inf[m].providers||{}).length>=3;}).slice(0,8);
  const bestProvPrices=compModels.map(m=>{const v=Object.values(inf[m].providers||{}).filter(x=>x>0);return v.length?Math.min(...v):null;});
  const bestGpuPrices=compModels.map(m=>{const v=inf[m].gpus?Object.values(inf[m].gpus).map(g=>g.cost_per_1m_tokens).filter(x=>x>0):[];return v.length?Math.min(...v):null;});
  if(charts.avs) charts.avs.destroy();
  charts.avs=new Chart(document.getElementById('chartApiVsSelfHosted'),{type:'bar',
    data:{labels:compModels,datasets:[
      {label:'Best Provider API',data:bestProvPrices,backgroundColor:C.cyan+'70',borderColor:C.cyan,borderWidth:1},
      {label:'Best Self-Hosted GPU',data:bestGpuPrices,backgroundColor:C.purple+'70',borderColor:C.purple,borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top',labels:{boxWidth:10,font:{size:10}}}},
      scales:{y:{title:{display:true,text:'$/M Tokens'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false},ticks:{font:{size:9},maxRotation:45}}}}
  });

  // Chart 3: Cost frontier scatter — model size vs best $/M tokens
  const scatterData=allModels.filter(m=>inf[m].providers&&Object.values(inf[m].providers).some(v=>v>0)).map(m=>{
    const best=Math.min(...Object.values(inf[m].providers).filter(v=>v>0));
    return {x:inf[m].params_b,y:best,label:m};
  });
  if(charts.it) charts.it.destroy();
  charts.it=new Chart(document.getElementById('chartInferenceThroughput'),{type:'scatter',
    data:{datasets:[{
      label:'Model',data:scatterData,
      backgroundColor:scatterData.map(d=>d.x<10?C.green+'90':d.x<100?C.cyan+'90':d.x<300?C.purple+'90':C.amber+'90'),
      borderColor:scatterData.map(d=>d.x<10?C.green:d.x<100?C.cyan:d.x<300?C.purple:C.amber),
      borderWidth:1,pointRadius:7,pointHoverRadius:10,
    }]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`${ctx.raw.label}: ${ctx.raw.x}B params, $${ctx.raw.y.toFixed(3)}/M tok`}}},
      scales:{x:{type:'logarithmic',title:{display:true,text:'Parameters (B)'},grid:{color:'rgba(26,34,51,0.4)'}},y:{type:'logarithmic',title:{display:true,text:'Best $/M Tokens (log)'},grid:{color:'rgba(26,34,51,0.4)'}}}}
  });

  // Chart 4: Provider coverage — how many models each provider supports
  const provCount={};
  allModels.forEach(m=>{if(inf[m].providers)Object.keys(inf[m].providers).forEach(p=>{provCount[p]=(provCount[p]||0)+1;});});
  const pcSorted=Object.entries(provCount).sort((a,b)=>b[1]-a[1]);
  if(charts.pc) charts.pc.destroy();
  charts.pc=new Chart(document.getElementById('chartProviderCoverage'),{type:'bar',
    data:{labels:pcSorted.map(e=>e[0]),datasets:[{label:'Models Supported',data:pcSorted.map(e=>e[1]),backgroundColor:pcSorted.map((_,i)=>CL[i%CL.length]+'70'),borderColor:pcSorted.map((_,i)=>CL[i%CL.length]),borderWidth:1}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false}},
      scales:{x:{title:{display:true,text:'# Models'},grid:{color:'rgba(26,34,51,0.4)'}},y:{grid:{display:false},ticks:{font:{size:10}}}}}
  });
}

// Wire up category filter
document.getElementById('inferCatFilter')?.addEventListener('change',function(){renderInferenceTab(this.value);});

// ════════════════════════════════════════════════════════════════
// TCO
// ════════════════════════════════════════════════════════════════
function renderTcoTab() {
  const tco=DATA.tco; if(!tco||!Object.keys(tco).length) return;
  // New TCO_PROFILES format: keyed by GPU name
  const gpus=Object.keys(tco).filter(k=>tco[k].gpu_price_usd!==undefined);
  if(!gpus.length) return;

  // ── Compute derived values per GPU ──
  const rows=gpus.map(g=>{
    const p=tco[g], sh=p.self_hosted;
    const powerCost=sh.power_kwh*sh.power_cost_kwh*sh.pue;
    const depreciation=p.gpu_price_usd/(p.useful_life_years*8760);
    const opex=powerCost+sh.networking_hr+sh.storage_hr+sh.colo_rack_hr+sh.ops_staff_hr;
    const selfTotal=opex+depreciation;
    const beMonths=p.cloud_on_demand_hr>opex?p.gpu_price_usd/((p.cloud_on_demand_hr-opex)*730):Infinity;
    const perfDollar=selfTotal>0?p.perf_fp16_tflops/selfTotal:0;
    return {gpu:g,price:p.gpu_price_usd,life:p.useful_life_years,
      cloudOD:p.cloud_on_demand_hr,cloud1yr:p.cloud_reserved_1yr_hr,
      cloud3yr:p.cloud_reserved_3yr_hr,cloudSpot:p.cloud_spot_hr,
      selfTotal,opex,depreciation,powerCost,
      beMonths,perfDollar,
      perf:p.perf_fp16_tflops,vram:p.vram_gb,
      sh};
  }).sort((a,b)=>a.selfTotal-b.selfTotal);

  // ── KPIs ──
  const cheapCloud=rows.reduce((a,b)=>a.cloudOD<b.cloudOD?a:b);
  const cheapSelf=rows[0];
  const fastBE=rows.filter(r=>isFinite(r.beMonths)).reduce((a,b)=>a.beMonths<b.beMonths?a:b,{beMonths:Infinity});
  const bestPerf=rows.reduce((a,b)=>a.perfDollar>b.perfDollar?a:b);
  document.getElementById('tcoStats').innerHTML=`
    <div class="kpi kpi-cyan"><div class="kpi-label">Cheapest Cloud $/hr</div><div class="kpi-value">$${cheapCloud.cloudOD.toFixed(2)}</div><div class="kpi-sub">${cheapCloud.gpu} on-demand</div></div>
    <div class="kpi kpi-green"><div class="kpi-label">Cheapest Self-Hosted</div><div class="kpi-value">$${cheapSelf.selfTotal.toFixed(2)}/hr</div><div class="kpi-sub">${cheapSelf.gpu} fully loaded</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">Fastest Break-Even</div><div class="kpi-value">${isFinite(fastBE.beMonths)?fastBE.beMonths.toFixed(0)+'mo':'N/A'}</div><div class="kpi-sub">${isFinite(fastBE.beMonths)?fastBE.gpu+' vs cloud OD':'—'}</div></div>
    <div class="kpi kpi-purple"><div class="kpi-label">Best Perf/$ (TFLOPS/$)</div><div class="kpi-value">${bestPerf.perfDollar.toFixed(0)}</div><div class="kpi-sub">${bestPerf.gpu} FP16</div></div>`;

  // ── Chart 1: Grouped bar — 4 scenarios per GPU ──
  if(charts.ts) charts.ts.destroy();
  const labels=rows.map(r=>r.gpu);
  charts.ts=new Chart(document.getElementById('chartTcoStack'),{type:'bar',
    data:{labels,datasets:[
      {label:'Cloud On-Demand',data:rows.map(r=>r.cloudOD),backgroundColor:C.red+'80',borderColor:C.red,borderWidth:1},
      {label:'Cloud 1yr Reserved',data:rows.map(r=>r.cloud1yr),backgroundColor:C.orange+'80',borderColor:C.orange,borderWidth:1},
      {label:'Cloud 3yr Reserved',data:rows.map(r=>r.cloud3yr),backgroundColor:C.amber+'80',borderColor:C.amber,borderWidth:1},
      {label:'Self-Hosted',data:rows.map(r=>r.selfTotal),backgroundColor:C.green+'80',borderColor:C.green,borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top'},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': $'+ctx.parsed.y.toFixed(2)+'/hr';}}}},
      scales:{x:{grid:{display:false}},y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}}}}
  });

  // ── Chart 2: Break-even cumulative cost lines (reference GPU = B200 or first) ──
  if(charts.tp) charts.tp.destroy();
  const refRow=rows.find(r=>r.gpu==='B200')||rows[0];
  document.getElementById('tcoPieTitle').textContent='Break-Even Timeline — '+refRow.gpu+' Self-Hosted vs Cloud';
  const months=Array.from({length:49},(_,i)=>i);
  const cumOD=months.map(m=>refRow.cloudOD*730*m);
  const cum3yr=months.map(m=>refRow.cloud3yr*730*m);
  const cumSelf=months.map(m=>refRow.price+refRow.opex*730*m);
  charts.tp=new Chart(document.getElementById('chartTcoPie'),{type:'line',
    data:{labels:months,datasets:[
      {label:'Cloud On-Demand',data:cumOD,borderColor:C.red,backgroundColor:C.red+'20',fill:false,tension:0,pointRadius:0,borderWidth:2},
      {label:'Cloud 3yr Reserved',data:cum3yr,borderColor:C.amber,backgroundColor:C.amber+'20',fill:false,tension:0,pointRadius:0,borderWidth:2},
      {label:'Self-Hosted',data:cumSelf,borderColor:C.green,backgroundColor:C.green+'20',fill:false,tension:0,pointRadius:0,borderWidth:2},
    ]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{position:'top'},tooltip:{callbacks:{label:function(ctx){return ctx.dataset.label+': $'+Math.round(ctx.parsed.y).toLocaleString();}}}},
      scales:{x:{title:{display:true,text:'Months'},grid:{color:'rgba(26,34,51,0.2)'}},
              y:{title:{display:true,text:'Cumulative Cost ($)'},grid:{color:'rgba(26,34,51,0.4)'},ticks:{callback:function(v){return '$'+Math.round(v/1000)+'k';}}}}}
  });

  // ── Table: 9 columns ──
  let h='<thead><tr><th>GPU</th><th class="r">VRAM</th><th class="r">FP16 TFLOPS</th><th class="r">Cloud OD</th><th class="r">Cloud 1yr</th><th class="r">Cloud 3yr</th><th class="r">Self-Hosted</th><th class="r">Break-Even</th><th class="r">Perf/$</th></tr></thead><tbody>';
  rows.forEach(r=>{
    const costs=[r.cloudOD,r.cloud1yr,r.cloud3yr,r.selfTotal];
    const minCost=Math.min(...costs);
    const fmt=(v)=>{const s='$'+v.toFixed(2);return v===minCost?`<span class="c-green fw">${s}</span>`:s;};
    h+=`<tr><td class="gpu-name">${r.gpu}</td>`;
    h+=`<td class="r">${r.vram} GB</td>`;
    h+=`<td class="r">${r.perf.toLocaleString()}</td>`;
    h+=`<td class="r">${fmt(r.cloudOD)}</td>`;
    h+=`<td class="r">${fmt(r.cloud1yr)}</td>`;
    h+=`<td class="r">${fmt(r.cloud3yr)}</td>`;
    h+=`<td class="r">${fmt(r.selfTotal)}</td>`;
    h+=`<td class="r">${isFinite(r.beMonths)?r.beMonths.toFixed(0)+' mo':'—'}</td>`;
    h+=`<td class="r c-purple fw">${r.perfDollar.toFixed(0)}</td></tr>`;
  });
  h+='</tbody>';
  document.getElementById('tcoTable').innerHTML=h;

  // ── Assumptions card ──
  const el=document.getElementById('tcoAssumptions');
  if(el) el.innerHTML=
    '<b>Self-hosted assumptions:</b> '+
    'Power cost $0.08/kWh (US industrial avg) · PUE 1.3 · '+
    'Useful life '+rows[0].life+' yr straight-line depreciation · '+
    'Colo/rack, networking, storage, and ops amortised per GPU-hr<br>'+
    '<b>Cloud pricing:</b> '+
    'On-demand = typical major-provider list price · '+
    '1yr reserved ≈ 30% discount · 3yr reserved ≈ 55% discount · '+
    'Break-even = months until self-hosted cumulative cost &lt; cloud on-demand<br>'+
    '<b>Hours/month:</b> 730 (24/7 operation)';
}

// ════════════════════════════════════════════════════════════════
// EFFICIENCY TAB
// ════════════════════════════════════════════════════════════════
function renderEfficiencyTab() {
  const util=DATA.utilization;
  if(!util||!Object.keys(util).length) return;

  // KPI stats
  const gpuIds=Object.keys(util);
  const avgUtil=gpuIds.reduce((s,g)=>s+util[g].avg_utilization,0)/gpuIds.length;
  const avgEff=gpuIds.reduce((s,g)=>s+util[g].avg_efficiency,0)/gpuIds.length;
  const bestGpu=gpuIds.reduce((a,b)=>util[a].avg_efficiency>util[b].avg_efficiency?a:b);
  const bestProv=Object.entries(util[bestGpu].providers).sort((a,b)=>b[1].efficiency_score-a[1].efficiency_score)[0];
  document.getElementById('effStats').innerHTML=`
    <div class="kpi kpi-cyan"><div class="kpi-label">Avg Utilization</div><div class="kpi-value">${avgUtil.toFixed(1)}%</div><div class="kpi-sub">Across ${gpuIds.length} GPU types</div></div>
    <div class="kpi kpi-green"><div class="kpi-label">Avg Efficiency</div><div class="kpi-value">${avgEff.toFixed(1)}</div><div class="kpi-sub">Score out of 100</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">Most Efficient GPU</div><div class="kpi-value">${bestGpu}</div><div class="kpi-sub">${util[bestGpu].avg_efficiency}/100</div></div>
    <div class="kpi kpi-purple"><div class="kpi-label">Top Provider</div><div class="kpi-value">${bestProv[0]}</div><div class="kpi-sub">${bestProv[1].efficiency_score}/100 on ${bestGpu}</div></div>`;

  // Utilization by Provider chart
  const providers=new Set();
  gpuIds.forEach(g=>Object.keys(util[g].providers).forEach(p=>providers.add(p)));
  const provArr=[...providers];
  if(charts.ubp) charts.ubp.destroy();
  charts.ubp=new Chart(document.getElementById('chartUtilByProvider'),{type:'bar',
    data:{labels:gpuIds,datasets:provArr.slice(0,6).map((p,i)=>({label:p,data:gpuIds.map(g=>util[g].providers[p]?.avg_utilization_pct||null),backgroundColor:CL[i]+'70',borderColor:CL[i],borderWidth:1}))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'Utilization %'},grid:{color:'rgba(26,34,51,0.4)'},max:100},x:{grid:{display:false}}}}
  });

  // Efficiency scores
  if(charts.eff) charts.eff.destroy();
  charts.eff=new Chart(document.getElementById('chartEfficiency'),{type:'radar',
    data:{labels:gpuIds,datasets:provArr.slice(0,5).map((p,i)=>({label:p,data:gpuIds.map(g=>util[g].providers[p]?.efficiency_score||0),borderColor:CL[i],backgroundColor:CL[i]+'20',pointBackgroundColor:CL[i],borderWidth:2}))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{r:{min:0,max:100,ticks:{stepSize:20,color:'#5c6980'},grid:{color:'rgba(26,34,51,0.4)'},pointLabels:{color:'#8a95a6',font:{size:10}}}}}
  });

  // Utilization trend lines
  const months=['Oct','Nov','Dec','Jan','Feb'];
  if(charts.utr) charts.utr.destroy();
  charts.utr=new Chart(document.getElementById('chartUtilTrend'),{type:'line',
    data:{labels:months,datasets:gpuIds.map((g,i)=>{
      const trend=util[g].providers[provArr[0]]?.utilization_trend||[];
      return {label:g,data:trend,borderColor:CL[i],tension:0.3,pointRadius:3,borderWidth:2,fill:false};
    })},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'Utilization %'},grid:{color:'rgba(26,34,51,0.4)'},max:100},x:{grid:{display:false}}}}
  });

}

// ════════════════════════════════════════════════════════════════
// FORECASTING TAB
// ════════════════════════════════════════════════════════════════
function renderForecastingTab() {
  const fc=DATA.forecasts, comp=DATA.competitive;
  if(!fc||!Object.keys(fc).length) return;

  const gpuIds=Object.keys(fc);

  // KPI stats
  const avgDecline=gpuIds.reduce((s,g)=>s+fc[g].elasticity_coefficient,0)/gpuIds.length;
  const mostElastic=gpuIds.reduce((a,b)=>fc[a].elasticity_coefficient<fc[b].elasticity_coefficient?a:b);
  const biggestDrop=gpuIds.reduce((a,b)=>{
    const da=(fc[a].current_avg-fc[a].forecast_12mo.mid)/fc[a].current_avg;
    const db=(fc[b].current_avg-fc[b].forecast_12mo.mid)/fc[b].current_avg;
    return da>db?a:b;
  });
  const dropPct=((fc[biggestDrop].current_avg-fc[biggestDrop].forecast_12mo.mid)/fc[biggestDrop].current_avg*100).toFixed(0);
  document.getElementById('forecastStats').innerHTML=`
    <div class="kpi kpi-blue"><div class="kpi-label">Avg Elasticity</div><div class="kpi-value">${avgDecline.toFixed(2)}</div><div class="kpi-sub">Price sensitivity coefficient</div></div>
    <div class="kpi kpi-red"><div class="kpi-label">Most Elastic</div><div class="kpi-value">${mostElastic}</div><div class="kpi-sub">Coeff: ${fc[mostElastic].elasticity_coefficient}</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">Biggest 12mo Decline</div><div class="kpi-value">${biggestDrop}</div><div class="kpi-sub">-${dropPct}% projected</div></div>
    <div class="kpi kpi-green"><div class="kpi-label">GPUs Tracked</div><div class="kpi-value">${gpuIds.length}</div><div class="kpi-sub">With forecast models</div></div>`;

  // Price forecast chart
  if(charts.pfc) charts.pfc.destroy();
  charts.pfc=new Chart(document.getElementById('chartForecast'),{type:'bar',
    data:{labels:gpuIds,datasets:[
      {label:'Current',data:gpuIds.map(g=>fc[g].current_avg),backgroundColor:C.blue+'70',borderColor:C.blue,borderWidth:1},
      {label:'3mo Forecast',data:gpuIds.map(g=>fc[g].forecast_3mo.mid),backgroundColor:C.cyan+'70',borderColor:C.cyan,borderWidth:1},
      {label:'6mo Forecast',data:gpuIds.map(g=>fc[g].forecast_6mo.mid),backgroundColor:C.amber+'70',borderColor:C.amber,borderWidth:1},
      {label:'12mo Forecast',data:gpuIds.map(g=>fc[g].forecast_12mo.mid),backgroundColor:C.green+'70',borderColor:C.green,borderWidth:1},
      {label:'Price Floor',data:gpuIds.map(g=>fc[g].price_floor),type:'line',borderColor:C.red,borderDash:[5,5],pointRadius:4,borderWidth:2,fill:false},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'$/hr'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  // Elasticity chart
  if(charts.elc) charts.elc.destroy();
  const sorted=[...gpuIds].sort((a,b)=>fc[a].elasticity_coefficient-fc[b].elasticity_coefficient);
  charts.elc=new Chart(document.getElementById('chartElasticity'),{type:'bar',
    data:{labels:sorted,datasets:[{label:'Elasticity Coefficient',data:sorted.map(g=>fc[g].elasticity_coefficient),backgroundColor:sorted.map(g=>fc[g].elasticity_coefficient<-0.4?C.red+'70':fc[g].elasticity_coefficient<-0.25?C.amber+'70':C.green+'70'),borderColor:sorted.map(g=>fc[g].elasticity_coefficient<-0.4?C.red:fc[g].elasticity_coefficient<-0.25?C.amber:C.green),borderWidth:1}]},
    options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false},title:{display:true,text:'More negative = more price sensitive',color:'#5c6980'}},scales:{x:{title:{display:true,text:'Elasticity'},grid:{color:'rgba(26,34,51,0.4)'}},y:{grid:{display:false}}}}
  });

  // Competitive moat radar
  if(comp&&Object.keys(comp).length) {
    const vendors=Object.keys(comp);
    const dims=['performance_score','ecosystem_maturity','software_compatibility','price_performance_ratio','moat_strength_score'];
    const dimLabels=['Performance','Ecosystem','Software','Price/Perf','Moat Strength'];
    if(charts.mrd) charts.mrd.destroy();
    charts.mrd=new Chart(document.getElementById('chartMoatRadar'),{type:'radar',
      data:{labels:dimLabels,datasets:vendors.map((v,i)=>({label:v.replace('_',' '),data:dims.map(d=>comp[v][d]),borderColor:CL[i],backgroundColor:CL[i]+'18',pointBackgroundColor:CL[i],borderWidth:2}))},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{r:{min:0,max:100,ticks:{stepSize:25,color:'#5c6980'},grid:{color:'rgba(26,34,51,0.4)'},pointLabels:{color:'#8a95a6',font:{size:11}}}}}
    });

    // Market share trend
    const periods=['2022','2023','2024','H1-25','2025'];
    if(charts.msh) charts.msh.destroy();
    charts.msh=new Chart(document.getElementById('chartMoatShare'),{type:'line',
      data:{labels:periods,datasets:vendors.map((v,i)=>({label:v.replace('_',' '),data:comp[v].market_share_trend,borderColor:CL[i],tension:0.3,pointRadius:4,borderWidth:2.5,fill:false}))},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'Market Share %'},grid:{color:'rgba(26,34,51,0.4)'},max:100},x:{grid:{display:false}}}}
    });

    // Competitive table
    let h='<table class="dt"><thead><tr><th>Vendor</th><th>Perf</th><th>Ecosystem</th><th>Software</th><th>Price/Perf</th><th>Moat</th><th>Share</th><th>Products</th></tr></thead><tbody>';
    vendors.forEach(v=>{
      const d=comp[v];
      const sc=c=>c>=80?'var(--green)':c>=60?'var(--amber)':'var(--red)';
      h+=`<tr><td style="color:var(--cyan);font-weight:700;">${v.replace('_',' ')}</td>
        <td style="color:${sc(d.performance_score)}">${d.performance_score}</td>
        <td style="color:${sc(d.ecosystem_maturity)}">${d.ecosystem_maturity}</td>
        <td style="color:${sc(d.software_compatibility)}">${d.software_compatibility}</td>
        <td style="color:${sc(d.price_performance_ratio)}">${d.price_performance_ratio}</td>
        <td style="color:${sc(d.moat_strength_score)};font-weight:700;">${d.moat_strength_score}</td>
        <td>${d.market_share_pct}%</td>
        <td style="font-size:10px;">${d.key_products.join(', ')}</td></tr>`;
    });
    h+='</tbody></table>';
    document.getElementById('competitiveTable').innerHTML=h;
  }
}

// ════════════════════════════════════════════════════════════════
// SUSTAINABILITY TAB
// ════════════════════════════════════════════════════════════════
function renderSustainabilityTab() {
  const sus=DATA.sustainability, sc=DATA.supplychain;
  if(!sus||!sus.providers) return;

  const provs=Object.keys(sus.providers);
  const carbon=sus.gpu_carbon||{};
  const carbonGpus=Object.keys(carbon);

  // KPI stats
  const avgScore=provs.reduce((s,p)=>s+sus.providers[p].avg_sustainability_score,0)/provs.length;
  const greenest=provs.reduce((a,b)=>sus.providers[a].avg_sustainability_score>sus.providers[b].avg_sustainability_score?a:b);
  const avgPue=provs.reduce((s,p)=>s+sus.providers[p].avg_pue,0)/provs.length;
  document.getElementById('susStats').innerHTML=`
    <div class="kpi kpi-green"><div class="kpi-label">Avg Sustainability</div><div class="kpi-value">${avgScore.toFixed(0)}</div><div class="kpi-sub">Score across ${provs.length} providers</div></div>
    <div class="kpi kpi-cyan"><div class="kpi-label">Greenest Provider</div><div class="kpi-value">${greenest}</div><div class="kpi-sub">${sus.providers[greenest].avg_sustainability_score}/100</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">Avg PUE</div><div class="kpi-value">${avgPue.toFixed(2)}</div><div class="kpi-sub">Power Usage Effectiveness</div></div>
    <div class="kpi kpi-purple"><div class="kpi-label">Supply Vendors</div><div class="kpi-value">${sc?.vendors?Object.keys(sc.vendors).length:'--'}</div><div class="kpi-sub">Tracked for risk</div></div>`;

  // Carbon by GPU
  if(charts.cbg) charts.cbg.destroy();
  charts.cbg=new Chart(document.getElementById('chartCarbonByGpu'),{type:'bar',
    data:{labels:carbonGpus,datasets:[
      {label:'US Average (kg CO2/yr)',data:carbonGpus.map(g=>carbon[g].carbon_kg_per_year_us_avg),backgroundColor:C.red+'70',borderColor:C.red,borderWidth:1},
      {label:'EU Nordic (kg CO2/yr)',data:carbonGpus.map(g=>carbon[g].carbon_kg_per_year_eu_nordic),backgroundColor:C.green+'70',borderColor:C.green,borderWidth:1},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'kg CO2/year'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  // PUE & Green Energy by provider
  if(charts.pge) charts.pge.destroy();
  charts.pge=new Chart(document.getElementById('chartPueGreen'),{type:'bar',
    data:{labels:provs,datasets:[
      {label:'Green Energy %',data:provs.map(p=>sus.providers[p].avg_green_energy_pct),backgroundColor:C.green+'70',borderColor:C.green,borderWidth:1,yAxisID:'y'},
      {label:'PUE',data:provs.map(p=>sus.providers[p].avg_pue),type:'line',borderColor:C.amber,borderWidth:2.5,pointRadius:4,yAxisID:'y1',fill:false},
    ]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{
      y:{title:{display:true,text:'Green Energy %'},grid:{color:'rgba(26,34,51,0.4)'},max:100},
      y1:{position:'right',title:{display:true,text:'PUE'},min:1.0,max:1.25,grid:{display:false}},
      x:{grid:{display:false}}}}
  });

  // Supply chain risk
  if(sc&&sc.vendors) {
    const vendors=Object.keys(sc.vendors);
    if(charts.scr) charts.scr.destroy();
    charts.scr=new Chart(document.getElementById('chartSupplyRisk'),{type:'bar',
      data:{labels:vendors,datasets:[
        {label:'Supply Risk Score',data:vendors.map(v=>sc.vendors[v].supply_risk_score),backgroundColor:vendors.map(v=>{const s=sc.vendors[v].supply_risk_score;return s>50?C.red+'70':s>35?C.amber+'70':C.green+'70';}),borderColor:vendors.map(v=>{const s=sc.vendors[v].supply_risk_score;return s>50?C.red:s>35?C.amber:C.green;}),borderWidth:1},
        {label:'TSMC Dependency %',data:vendors.map(v=>sc.vendors[v].tsmc_dependency_pct),backgroundColor:C.purple+'50',borderColor:C.purple,borderWidth:1},
      ]},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'Score / %'},grid:{color:'rgba(26,34,51,0.4)'},max:100},x:{grid:{display:false}}}}
    });

    // Lead time trend
    const periods=['2023-Q1','2023-Q3','2024-Q1','2024-Q3','2025-Q1'];
    if(charts.ltt) charts.ltt.destroy();
    charts.ltt=new Chart(document.getElementById('chartRiskTrend'),{type:'line',
      data:{labels:periods,datasets:vendors.map((v,i)=>({label:v,data:sc.vendors[v].lead_time_trend,borderColor:CL[i],tension:0.35,pointRadius:4,borderWidth:2.5,fill:false}))},
      options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'Lead Time (weeks)'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
    });

    // Sustainability score table
    let h='<table class="dt"><thead><tr><th>Provider</th><th>Region</th><th>Score</th><th>Green %</th><th>PUE</th><th>CO2 g/kWh</th><th>Water L/kWh</th></tr></thead><tbody>';
    provs.forEach(p=>{
      const regions=sus.providers[p].regions;
      Object.entries(regions).forEach(([reg,d])=>{
        const sc2=d.sustainability_score>=80?'var(--green)':d.sustainability_score>=60?'var(--amber)':'var(--red)';
        h+=`<tr><td style="color:var(--cyan);font-weight:600;">${p}</td><td>${reg}</td>
          <td style="color:${sc2};font-weight:700;">${d.sustainability_score}</td>
          <td>${d.green_energy_pct}%</td><td>${d.pue}</td>
          <td>${d.carbon_gco2_per_kwh}</td><td>${d.water_usage_l_per_kwh}</td></tr>`;
      });
    });
    h+='</tbody></table>';
    document.getElementById('sustainabilityTable').innerHTML=h;

    // Export control & regulatory timeline
    if(sc.export_controls) {
      const regions=['US','EU','China','Japan','India','Middle_East','SE_Asia'];
      const regionLabels={US:'US',EU:'EU',China:'CN',Japan:'JP',India:'IN',Middle_East:'ME',SE_Asia:'SEA'};
      const riColor=v=>v==='high_positive'||v==='major_benefit'?'var(--green)':v==='positive'||v==='positive_industry'||v==='positive_enforcement'?'var(--green)':(v==='negative'||v==='high_negative'||v==='negative_domestic')?'var(--red)':(v==='low_negative')?'#e08040':v==='mixed'?'var(--amber)':v==='uncertain'?'var(--purple)':'var(--text-3)';
      const riIcon=v=>v==='high_positive'||v==='major_benefit'?'++':v==='positive'||v==='positive_industry'||v==='positive_enforcement'?'+':v==='high_negative'?'--':(v==='negative'||v==='negative_domestic')?'-':v==='low_negative'?'~-':v==='mixed'?'+-':v==='uncertain'?'?':'·';
      const statusBadge=s=>{const m={enacted:'background:var(--green-dim);color:var(--green)',in_effect:'background:var(--green-dim);color:var(--green)',rescinded:'background:var(--red-dim);color:var(--red)',proposed:'background:var(--amber-dim);color:var(--amber)',in_committee:'background:var(--amber-dim);color:var(--amber)',temporary:'background:var(--purple-dim);color:var(--purple)',upcoming:'background:var(--blue-dim);color:var(--blue)'};return`<span style="padding:1px 6px;border-radius:3px;font-size:9px;font-weight:700;text-transform:uppercase;white-space:nowrap;${m[s]||''}">${(s||'').replace(/_/g,' ')}</span>`;};
      let eh='<table class="dt" style="font-size:11px;"><thead><tr><th style="width:60px;">Date</th><th>Regulation</th><th style="width:90px;">Category</th><th>Target</th><th style="width:50px;">Status</th><th style="width:40px;">Imp.</th>';
      regions.forEach(r=>eh+=`<th style="width:28px;text-align:center;font-size:9px;padding:4px 2px;">${regionLabels[r]}</th>`);
      eh+='<th>GPUs</th><th>Description</th></tr></thead><tbody>';
      sc.export_controls.forEach(e=>{
        const ic=e.impact==='high'?'var(--red)':e.impact==='medium'?'var(--amber)':'var(--green)';
        const gpus=(e.affected_gpus||[]).length?e.affected_gpus.slice(0,3).join(', ')+(e.affected_gpus.length>3?' +':''):'—';
        eh+=`<tr><td style="font-family:var(--mono);color:var(--text-2);white-space:nowrap;">${e.date}</td>
          <td style="color:var(--cyan);font-weight:600;white-space:nowrap;">${e.regulation}</td>
          <td style="font-size:10px;color:var(--text-2);">${e.category||''}</td>
          <td style="font-size:10px;">${e.target}</td>
          <td>${statusBadge(e.status)}</td>
          <td style="color:${ic};font-weight:700;text-transform:uppercase;text-align:center;">${e.impact}</td>`;
        regions.forEach(r=>{
          const v=e.regional_impact?.[r]||'neutral';
          eh+=`<td style="text-align:center;color:${riColor(v)};font-weight:700;font-size:10px;" title="${r}: ${v.replace(/_/g,' ')}">${riIcon(v)}</td>`;
        });
        eh+=`<td style="font-size:10px;color:var(--text-2);white-space:nowrap;">${gpus}</td>
          <td style="font-size:10px;max-width:320px;">${e.description}</td></tr>`;
      });
      eh+='</tbody></table>';
      eh+='<div style="margin-top:8px;font-size:9px;color:var(--text-3);display:flex;gap:12px;flex-wrap:wrap;">';
      eh+='<span>Regional impact: <b style="color:var(--green);">++</b> major benefit <b style="color:var(--green);">+</b> positive <b style="color:var(--amber);">+-</b> mixed <b style="color:var(--text-3);">·</b> neutral <b style="color:#e08040;">~-</b> low negative <b style="color:var(--red);">-</b> negative <b style="color:var(--red);">--</b> high negative <b style="color:var(--purple);">?</b> uncertain</span>';
      eh+='</div>';
      document.getElementById('exportControlTable').innerHTML=eh;
    }
  }
}

// ════════════════════════════════════════════════════════════════
// MODEL FIT TAB
// ════════════════════════════════════════════════════════════════
function renderModelFitTab() {
  const mf=DATA.modelfit;
  if(!mf||!Object.keys(mf).length) return;

  const sizes=Object.keys(mf);

  // KPI stats
  let bestOverall={score:0,gpu:'',size:''};
  let cheapest={cost:999,gpu:'',size:''};
  sizes.forEach(s=>{
    Object.entries(mf[s].gpus).forEach(([g,d])=>{
      if(d.fit_score>bestOverall.score) bestOverall={score:d.fit_score,gpu:g,size:s};
      if(d.cost_per_1m_tokens<cheapest.cost) cheapest={cost:d.cost_per_1m_tokens,gpu:g,size:s};
    });
  });
  document.getElementById('fitStats').innerHTML=`
    <div class="kpi kpi-green"><div class="kpi-label">Best Overall Fit</div><div class="kpi-value">${bestOverall.gpu}</div><div class="kpi-sub">${bestOverall.size} params, score: ${bestOverall.score}</div></div>
    <div class="kpi kpi-cyan"><div class="kpi-label">Cheapest Inference</div><div class="kpi-value">$${cheapest.cost}</div><div class="kpi-sub">${cheapest.gpu} for ${cheapest.size} models</div></div>
    <div class="kpi kpi-amber"><div class="kpi-label">Model Sizes</div><div class="kpi-value">${sizes.length}</div><div class="kpi-sub">${sizes.join(', ')} params</div></div>
    <div class="kpi kpi-purple"><div class="kpi-label">Configurations</div><div class="kpi-value">${sizes.reduce((s,sz)=>s+Object.keys(mf[sz].gpus).length,0)}</div><div class="kpi-sub">GPU+model combos</div></div>`;

  // Cost per 1M tokens by size
  const allGpus=new Set();
  sizes.forEach(s=>Object.keys(mf[s].gpus).forEach(g=>allGpus.add(g)));
  const gpuArr=[...allGpus];
  if(charts.fcc) charts.fcc.destroy();
  charts.fcc=new Chart(document.getElementById('chartFitCost'),{type:'bar',
    data:{labels:sizes.map(s=>s+' params'),datasets:gpuArr.map((g,i)=>({label:g,data:sizes.map(s=>mf[s].gpus[g]?.cost_per_1m_tokens||null),backgroundColor:CL[i%CL.length]+'70',borderColor:CL[i%CL.length],borderWidth:1}))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'$/M Tokens'},grid:{color:'rgba(26,34,51,0.4)'}},x:{grid:{display:false}}}}
  });

  // Fit score chart
  if(charts.fsc) charts.fsc.destroy();
  charts.fsc=new Chart(document.getElementById('chartFitScore'),{type:'bar',
    data:{labels:sizes.map(s=>s+' params'),datasets:gpuArr.map((g,i)=>({label:g,data:sizes.map(s=>mf[s].gpus[g]?.fit_score||null),backgroundColor:CL[i%CL.length]+'70',borderColor:CL[i%CL.length],borderWidth:1}))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'}},scales:{y:{title:{display:true,text:'Fit Score (0-100)'},grid:{color:'rgba(26,34,51,0.4)'},max:100},x:{grid:{display:false}}}}
  });

  // Throughput vs cost scatter (frontier)
  const scatterData=[];
  sizes.forEach((s,si)=>{
    Object.entries(mf[s].gpus).forEach(([g,d])=>{
      scatterData.push({x:d.cost_per_1m_tokens,y:d.throughput_tok_s,label:`${g} (${s})`,size:s,gpu:g,sizeIdx:si});
    });
  });
  if(charts.fft) charts.fft.destroy();
  charts.fft=new Chart(document.getElementById('chartFitFrontier'),{type:'scatter',
    data:{datasets:sizes.map((s,i)=>({
      label:s+' params',
      data:scatterData.filter(d=>d.size===s).map(d=>({x:d.x,y:d.y})),
      backgroundColor:CL[i]+'90',
      borderColor:CL[i],
      borderWidth:1.5,
      pointRadius:6,
    }))},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'top'},tooltip:{callbacks:{label:function(ctx){const d=scatterData.filter(d=>d.size===sizes[ctx.datasetIndex])[ctx.dataIndex];return d?`${d.gpu}: $${d.x}/M tok, ${d.y} tok/s`:'';}}}},
      scales:{x:{title:{display:true,text:'Cost ($/M tokens)'},grid:{color:'rgba(26,34,51,0.4)'}},y:{title:{display:true,text:'Throughput (tok/s)'},grid:{color:'rgba(26,34,51,0.4)'}}}}
  });

  // VRAM headroom chart
  if(charts.fvr) charts.fvr.destroy();
  const vramData=[];sizes.forEach(s=>{Object.entries(mf[s].gpus).forEach(([g,d])=>{vramData.push({label:`${g}\n(${s})`,val:d.vram_headroom_pct});});});
  charts.fvr=new Chart(document.getElementById('chartFitVram'),{type:'bar',
    data:{labels:vramData.map(d=>d.label),datasets:[{label:'VRAM Headroom %',data:vramData.map(d=>d.val),backgroundColor:vramData.map(d=>d.val>50?C.green+'70':d.val>20?C.amber+'70':C.red+'70'),borderColor:vramData.map(d=>d.val>50?C.green:d.val>20?C.amber:C.red),borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{title:{display:true,text:'VRAM Headroom %'},grid:{color:'rgba(26,34,51,0.4)'},max:100},x:{grid:{display:false},ticks:{font:{size:8},maxRotation:90}}}}
  });

  // Fit matrix table
  let h='<table class="dt"><thead><tr><th>Model Size</th><th>GPU</th><th>Config</th><th>Throughput</th><th>Cost/1M Tok</th><th>VRAM Headroom</th><th>Fit Score</th><th>Notes</th></tr></thead><tbody>';
  sizes.forEach(s=>{
    const entries=Object.entries(mf[s].gpus).sort((a,b)=>b[1].fit_score-a[1].fit_score);
    entries.forEach(([g,d],idx)=>{
      const sc=d.fit_score>=85?'var(--green)':d.fit_score>=70?'var(--amber)':'var(--red)';
      const vr=d.vram_headroom_pct>50?'var(--green)':d.vram_headroom_pct>20?'var(--amber)':'var(--red)';
      h+=`<tr><td style="color:var(--purple);font-weight:600;">${idx===0?s:''}</td>
        <td style="color:var(--cyan);font-weight:600;">${g}</td>
        <td style="font-family:var(--mono);font-size:10px;">${d.optimal_config}</td>
        <td>${d.throughput_tok_s} tok/s</td>
        <td style="font-weight:600;">$${d.cost_per_1m_tokens}</td>
        <td style="color:${vr}">${d.vram_headroom_pct}%</td>
        <td style="color:${sc};font-weight:700;">${d.fit_score}/100</td>
        <td style="font-size:10px;color:var(--text-3);">${d.notes}</td></tr>`;
    });
  });
  h+='</tbody></table>';
  document.getElementById('fitTable').innerHTML=h;
}

// ════════════════════════════════════════════════════════════════
// AI INTELLIGENCE SYSTEM
// ════════════════════════════════════════════════════════════════

const AI_MAP = {
  'summary':    {url:'/api/ai/summary',     el:'aiSummaryContent',        status:null},
  'trends':     {url:'/api/ai/trends',       el:'aiTrendsContent',         status:'statusTrends'},
  'regional':   {url:'/api/ai/regional',     el:'aiRegionalContent',       status:'statusRegional'},
  'investment': {url:'/api/ai/investment',    el:'aiInvestmentContent',     status:'statusInvestment'},
  'notes':      {url:'/api/ai/notes',        el:'aiNotesContent',          status:null},
  'efficiency': {url:'/api/ai/efficiency',    el:'aiEfficiencyContent',     status:'statusEfficiency'},
  'forecast':   {url:'/api/ai/forecast',      el:'aiForecastContent',       status:'statusForecast'},
  'sustainability':{url:'/api/ai/sustainability',el:'aiSustainabilityContent',status:'statusSustainability'},
};

let aiLoadedSet = new Set();
let aiRunningCount = 0;

function setAIStatus(statusId, state) {
  if(!statusId) return;
  const el = document.getElementById(statusId);
  if(!el) return;
  el.className = 'intel-status intel-status-' + (state==='loading'?'loading':state==='ready'?'ready':'idle');
  el.textContent = state==='loading'?'RUNNING':state==='ready'?'READY':'IDLE';
}

function updateGlobalStatus() {
  const gs = document.getElementById('aiGlobalStatus');
  if(!gs) return;
  if(aiRunningCount > 0) {
    gs.className = 'intel-status intel-status-loading';
    gs.textContent = `${aiRunningCount} RUNNING`;
  } else if(aiLoadedSet.size > 0) {
    gs.className = 'intel-status intel-status-ready';
    gs.textContent = `${aiLoadedSet.size}/${Object.keys(AI_MAP).length-1} READY`;
  } else {
    gs.className = 'intel-status intel-status-idle';
    gs.textContent = 'IDLE';
  }
}

// Post-process AI markdown: highlight signal tags and key metrics
function formatAIOutput(raw) {
  let html = marked.parse(raw || '');
  // Signal tags: [BUY] [SELL] [HOLD] [WATCH] [ALERT] [BULL] [BEAR]
  html = html.replace(/\[BUY\]/gi, '<span class="ai-sig ai-sig-buy">BUY</span>');
  html = html.replace(/\[SELL\]/gi, '<span class="ai-sig ai-sig-sell">SELL</span>');
  html = html.replace(/\[HOLD\]/gi, '<span class="ai-sig ai-sig-hold">HOLD</span>');
  html = html.replace(/\[WATCH\]/gi, '<span class="ai-sig ai-sig-watch">WATCH</span>');
  html = html.replace(/\[ALERT\]/gi, '<span class="ai-sig ai-sig-alert">ALERT</span>');
  html = html.replace(/\[BULL\]/gi, '<span class="ai-sig ai-sig-bull">BULL</span>');
  html = html.replace(/\[BEAR\]/gi, '<span class="ai-sig ai-sig-bear">BEAR</span>');
  // Highlight dollar amounts
  html = html.replace(/(\$[\d,.]+(?:\/hr|\/mo|\/yr|B|M|K)?)/g, '<code>$1</code>');
  // Highlight percentages with direction
  html = html.replace(/([-+]?\d+\.?\d*%)/g, function(m) {
    const v = parseFloat(m);
    if(v > 0) return `<span style="color:var(--green);font-weight:600;">${m}</span>`;
    if(v < 0) return `<span style="color:var(--red);font-weight:600;">${m}</span>`;
    return m;
  });
  return html;
}

async function loadAI(type, bypassCache) {
  const cfg = AI_MAP[type];
  if(!cfg) return;
  const el = document.getElementById(cfg.el);
  if(!el) return;

  // Use embedded AI data when available (static deployment or cached)
  if(typeof EMBEDDED_AI !== 'undefined' && EMBEDDED_AI[type]) {
    const cached = EMBEDDED_AI[type];
    const raw = cached.analysis || cached.quick_summary || JSON.stringify(cached);
    el.innerHTML = formatAIOutput(raw);
    setAIStatus(cfg.status, 'ready');
    aiLoadedSet.add(type);
    updateGlobalStatus();
    return;
  }

  // Live server mode — fetch from API
  el.innerHTML = '<div class="ai-loading"><div class="ai-spinner"></div>Generating analysis&hellip; This may take 15-30 seconds</div>';
  setAIStatus(cfg.status, 'loading');
  aiRunningCount++;
  updateGlobalStatus();

  try {
    const url = bypassCache ? cfg.url + (cfg.url.includes('?') ? '&' : '?') + 'nocache=1' : cfg.url;
    const r = await fetchJSON(url);
    if(r.error) {
      el.innerHTML = `<div style="color:var(--red);padding:20px;font-size:12px;"><strong>Error:</strong> ${r.error}</div>`;
      setAIStatus(cfg.status, 'idle');
    } else {
      const raw = r.analysis || r.quick_summary || JSON.stringify(r);
      el.innerHTML = formatAIOutput(raw);
      setAIStatus(cfg.status, 'ready');
      aiLoadedSet.add(type);
    }
  } catch(e) {
    el.innerHTML = `<div style="color:var(--red);padding:20px;font-size:12px;"><strong>Failed:</strong> ${e.message}</div>`;
    setAIStatus(cfg.status, 'idle');
  }
  aiRunningCount = Math.max(0, aiRunningCount - 1);
  updateGlobalStatus();
}

async function loadAllAI() {
  const btn = document.getElementById('btnGenerateAll');
  if(btn) { btn.textContent = 'Generating...'; btn.disabled = true; }
  // Fire all intelligence reports in parallel
  const types = ['notes','trends','investment','regional','efficiency','forecast','sustainability'];
  await Promise.all(types.map(t => loadAI(t)));
  if(btn) { btn.textContent = 'Generate All Reports'; btn.disabled = false; }
}

async function refreshAllAI() {
  // On static deployment, just re-render from embedded data
  const types = ['notes','trends','investment','regional','efficiency','forecast','sustainability'];
  if(IS_STATIC) {
    aiLoadedSet.clear();
    await Promise.all(types.map(t => loadAI(t)));
    return;
  }
  aiLoadedSet.clear();
  await Promise.all(types.map(t => loadAI(t, true)));
}

async function loadGpuAI() {
  const gpuId = document.getElementById('aiGpuSelect').value;
  if(!gpuId) return;
  const name = DATA.specs[gpuId]?.name || gpuId;
  document.getElementById('aiGpuTitle').textContent = `GPU Deep Dive — ${name}`;
  const el = document.getElementById('aiGpuContent');
  const statusEl = document.getElementById('statusGpu');

  // Use embedded AI data when available
  const embeddedKey = 'gpu_' + gpuId;
  if(typeof EMBEDDED_AI !== 'undefined' && EMBEDDED_AI[embeddedKey]) {
    el.innerHTML = formatAIOutput(EMBEDDED_AI[embeddedKey].analysis || '');
    if(statusEl) { statusEl.className='intel-status intel-status-ready'; statusEl.textContent='READY'; }
    return;
  }

  // Live server fallback
  el.innerHTML = `<div class="ai-loading"><div class="ai-spinner"></div>Analyzing ${name}&hellip;</div>`;
  if(statusEl) { statusEl.className='intel-status intel-status-loading'; statusEl.textContent='RUNNING'; }

  try {
    const r = await fetchJSON(`/api/ai/gpu?id=${gpuId}`);
    if(r.error) el.innerHTML = `<div style="color:var(--red);padding:20px;">Error: ${r.error}</div>`;
    else el.innerHTML = formatAIOutput(r.analysis || '');
    if(statusEl) { statusEl.className='intel-status intel-status-ready'; statusEl.textContent='READY'; }
  } catch(e) {
    el.innerHTML = `<div style="color:var(--red);padding:20px;">Failed: ${e.message}</div>`;
    if(statusEl) { statusEl.className='intel-status intel-status-idle'; statusEl.textContent='IDLE'; }
  }
}

// Auto-load AI for tab-specific panels when tab is visited
const aiTabAutoLoad = {
  'efficiency': 'efficiency',
  'forecasting': 'forecast',
  'sustainability': 'sustainability',
};
document.addEventListener('click', function(e) {
  const navItem = e.target.closest('.nav-item');
  if(!navItem) return;
  const tabId = navItem.dataset.tab;
  if(aiTabAutoLoad[tabId] && !aiLoadedSet.has(aiTabAutoLoad[tabId])) {
    loadAI(aiTabAutoLoad[tabId]);
  }
});

// ════════════════════════════════════════════════════════════════
// INIT
// ════════════════════════════════════════════════════════════════
loadAllData();
</script>
</body>
</html>
